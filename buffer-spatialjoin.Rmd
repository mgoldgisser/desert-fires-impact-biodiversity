---
title: "Buffer spatial join"
author: "Marina Goldgisser"
date: "8/2/2021"
output: html_document
---

#filter observation data by fire shapefile


```{r warning=FALSE}
library(tidyverse)
library(sf)

# read animal shapefile of already filtered dataset
# gbifdata <- read_csv("data/animals-buffer-1km.csv") %>% 
#   rename("decimalLongitude" = "dcmlLng", "decimalLatitude" = "dcmlLtt", "individualCount" = "indvdlC", "basisOfRecord" = "bssOfRc")

#transform to shapefile and add projection
#gbif_sf <- st_as_sf(gbifdata, coords = c("decimalLongitude", "decimalLatitude"), crs = 4326, remove = FALSE)


#load shapefile of unfiltered endangered animals in CA
gbif_sf <- st_read("./shapefiles/endangeredanimals")

#adding obs ID; but need to do this after the spatial join so that the ones that already have one aren't given another one.
#id <- rownames(gbif_sf) 
#gbif_sf <- cbind(obsID=id, gbif_sf)

#add fire shapefile
fire_sf <- st_read("shapefiles/fire-buffer-5km-ring") %>% 
  st_make_valid(fire_sf)

#not needed, but this transforms the projections so that they are the same
# gbif_sf <- st_transform(gbif_sf, st_crs(fire_sf))

#spatial aggregation: observation points to fire polygons
filter_gbif <- st_filter(gbif_sf, fire_sf, .predicate = st_within)
join_fire_gbif <- st_join(filter_gbif, fire_sf, join = st_within) %>% 
  st_drop_geometry() %>% 
  rename(fireyear = FIRE_YEARn, firename = INCIDENT, firesize = GISAcres, buffSize_km = BUFF_DIST, buffArea_acres = buff_area)

#counts up multiple instances and generates new vector as counts by grouping factors####
fire_total_obs <- join_fire_gbif %>% 
  group_by(fireID, firename, fireyear, firesize, buffSize_km, buffArea_acres) %>% 
  summarize(n_observations = n()) 
  
write_csv(fire_total_obs, "data/bronze-buffer-5km_.csv")
write_csv(join_fire_gbif, "data/gold-buffer-5km_.csv")

```