---
title: "Final Project"
author: "Marina"
date: "12/8/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```


```{r, load libraries}
setwd("~/GitHub/desert-fires-impact-biodiversity")
library(tidyverse)
library(vegan)
library(ggfortify)
library(skimr)
```

# Baseline data
```{r}

#endangered animal species data for never-burned area
MOJ <- read_csv("data/animals-no-burn_MOJ.csv")
SJ <- read_csv("data/animals-no-burn_SJ.csv")
SON <- read_csv("data/animals-no-burn_SON.csv")

#add column for desert
MOJ$desert <- ifelse(is.na(MOJ$desert), "Mojave", MOJ$desert)
SJ$desert <- ifelse(is.na(SJ$desert), "San Joaquin", SJ$desert)
SON$desert <- ifelse(is.na(SON$desert), "Sonoran", SON$desert)

#add column for kingdom taxa for modeling
raw_an <- bind_rows(MOJ, SJ, SON) %>% 
  dplyr::select(-FID) %>% 
  mutate(kingdom = "animalia")

#plant data in never-burned area
MOJ_pl <- read_csv("data/plants-noburn-MOJ.csv")
SJ_pl <- read_csv("data/plants-noburn-SJ.csv")
SON_pl <- read_csv("data/plants-noburn-SON.csv")

#tidyupd data
raw_pl <- bind_rows(MOJ_pl, SJ_pl, SON_pl) %>% 
  rename(obsID = OBJECTID, dcmlLng = decimalLongitude, dcmlLtt = decimalLatitude, bssOfRc = basisOfRecord, indvdlC = individualCount, order = order_) %>% 
  dplyr::select(c(obsID, species, kingdom, class, order, year, month, day, dcmlLng, dcmlLtt, indvdlC, bssOfRc, desert))

raw_pl$indvdlC <- ifelse(is.na(raw_pl$indvdlC), 0, raw_pl$indvdlC)

#join plant and animal data
raw <- union(raw_an, raw_pl)

#summarize total animal occurrences between 1995 and 2021
data <- raw_an %>%
  group_by(year, desert) %>% 
  summarize(totalObs = n()) %>% 
  filter(year >1994, year <2021)

#plot showing the change in total occurrences per year over the 15 year period
ggplot(data, aes(x = year, y = totalObs, col = desert, shape = desert)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "poisson"), aes(fill = desert)) +
  ylim(0, 1750) +
  xlim(1995, 2020) +
  ylab("Total endangered animal species \n occurrences")+
  theme_bw(base_size = 15) +
  scale_color_manual(values = c("darkgoldenrod4", "darkblue", "green4")) +
  scale_fill_manual(values = c("darkgoldenrod4", "darkblue", "green4"))


```

generalized linear model using Poisson regression
```{r}
#check for data distribution
ggplot(data, aes(totalObs)) +
  geom_histogram()

#check if mean = variance
mean(data$totalObs)
var(data$totalObs)

model1 <- glm(totalObs ~ year, family = "quasipoisson", data)
model2 <- glm(totalObs ~ year, family = "poisson", data)

summary(model1)
summary(model2)

pchisq(model1$deviance, model1$df.residual, lower.tail=F)
pchisq(model2$deviance, model1$df.residual, lower.tail=F)

```

Average percent change in occurrence records year-to-year
```{r}
data <- data %>% 
  filter(year >= 1990) %>% 
  group_by(desert) %>% 
  arrange(year, .by_group = TRUE) %>% 
  mutate(pct_change = ((totalObs - lag(totalObs))/lag(totalObs))*100)

#2021 was pulled earlier in the year so need to filter out
data <- data %>% 
  filter(year != 2021)

#avg change among desert
change <- data %>% 
  group_by(year) %>% 
  summarize(avg_pct_change = mean(pct_change))

#viz of avg percent change
change <- change %>% 
  mutate(pos = avg_pct_change >= 0)

sum(data$totalObs)
summary(data$totalObs)


ggplot(change, aes(year, avg_pct_change, fill = pos)) +
  geom_col()+
  theme_bw(base_size = 22) +
  theme(legend.position = "None") +
  ylab("Average \n percent change") +
  scale_fill_manual(values = c("red3", "blue4")) + ggtitle("Figure 2a")

#viz avg percent change in burned area
burn_data <- read_csv("data/observations.csv")
burn_data <- burn_data %>%
  group_by(obsYear) %>% 
  summarize(totalObs = n()) %>% 
  filter(obsYear >= 1990) %>% 
  filter(obsYear != 2021) %>% 
  arrange(obsYear) %>% 
  mutate(pct_change = ((totalObs - lag(totalObs))/lag(totalObs))*100) %>% 
  mutate(pos = pct_change >= 0)
  
ggplot(burn_data, aes(obsYear, pct_change, fill = pos)) +
  geom_col()+ theme_bw(base_size = 22) +
  theme(legend.position = "None") +
  ylab("Average \n percent change") +
  xlab("year") +
  scale_fill_manual(values = c("red3", "blue4")) +
  theme(legend.position = "None") + ggtitle("Figure 2b")
  
```

# PCA for plant species
```{r}
#load data
sites <- read_csv("data/sites.csv")  %>%
  select(c(fireID, fireMonth, desert))
plants <- read_csv("data/plants-at-fire-sites.csv") %>% 
  left_join(sites, by = "fireID")

#list of unique plant species
species <- plants %>% select(c(genus, species)) %>% 
  unique()

#filter plants for key native genus and key invasive species
native_genus <- c("Ephedra", "Yucca", "Opuntia", "Ambrosia", "Atriplex", "Olneya", "Carnegiea", "Larrea")
inv_genus <- c("Bromus", "Schismus", "Pennisetum")

native_spe <- species %>% 
  filter(genus %in% native_genus)

inv_spe <- species %>% 
  filter(genus %in% inv_genus)

plants_native <- plants %>% 
  filter(genus %in% native_genus)

plants_invasive <- plants %>% 
  filter(genus %in% inv_genus)

```

```{r, add pre or post to data}

#native species
plants_native <- plants_native %>% 
  mutate(postingvalue = obsYear - fireYear, 
         pre_or_post = case_when(postingvalue > 0 ~ "post",
                                 postingvalue < 0 ~ "pre",
                                 postingvalue == 0 ~ "SY"),
         n_years = abs(postingvalue))

#find pre- post- for observations in the same year and replace SY in datafire with pre or post
SY <- filter(plants_native, postingvalue == 0) %>% 
  mutate(postingmonth = month - fireMonth,
    pre_or_post = case_when(postingmonth >0 ~ "post",
                            postingmonth < 0 ~ "pre",
                            postingvalue == 0 ~ "SM"))

plants_native$pre_or_post <- ifelse(plants_native$pre_or_post == "SY", SY$pre_or_post, plants_native$pre_or_post)

unique(plants_native$pre_or_post) 

#check if any SM (same month); would need to further categorize

plants_group_nat <-  plants_native %>% 
  group_by(fireID, pre_or_post) %>% 
  summarize(total = n())

view(plants_group_nat)

#invasive species 
plants_invasive <- plants_invasive %>% 
  mutate(postingvalue = obsYear - fireYear, 
         pre_or_post = case_when(postingvalue > 0 ~ "post",
                                 postingvalue < 0 ~ "pre",
                                 postingvalue == 0 ~ "SY"),
         n_years = abs(postingvalue))

#find pre- post- for observations in the same year and replace SY in datafire with pre or post
SY <- filter(plants_invasive, postingvalue == 0) %>% 
  mutate(postingmonth = month - fireMonth,
    pre_or_post = case_when(postingmonth >0 ~ "post",
                            postingmonth < 0 ~ "pre",
                            postingvalue == 0 ~ "SM"))

plants_invasive$pre_or_post <- ifelse(plants_invasive$pre_or_post == "SY", SY$pre_or_post, plants_invasive$pre_or_post)

unique(plants_invasive$pre_or_post) #check if any SM (same month); would need to further categorize

plants_group_inv <-  plants_invasive %>% 
  group_by(fireID, pre_or_post) %>% 
  summarize(total = n())

view(plants_group_inv)

```

create species matrix for PCA
```{r, make sites x species matrix for pre and post fire data}

plants <- union(plants_native, plants_invasive)

matrix <- plants %>%
  filter(n_years > -5, n_years < 5) %>%
  select(c(fireID, genus, pre_or_post)) %>% 
  rename(sites = fireID) %>%  
  group_by(sites, genus, pre_or_post) %>% 
  summarize(abundance = n()) %>% 
  spread(genus, abundance)
  
#view(matrix)

#replace NA with 0
matrix[is.na(matrix)] <- 0

plants.pca <- rda(matrix[,-1:-2])

#remove atriplex (native plant species; already have more native species than invasives)

#
summary(plants.pca)

plants.pca <- prcomp(matrix[3:8], scale = FALSE)

autoplot(plants.pca, data=matrix, colour = "pre_or_post", loadings = TRUE, 
         loadings.label = TRUE, loadings.label.size = 3,loadings.label.vjust = c(0, 1.2, 1, 1.3, 1, 0), loadings.label.hjust = c(-0.1, 0, -0.2, 0, -0.2, 0.6), legend.title = "none") + 
  geom_point(size = 3, colour = c("red3", "darkslateblue",  "red3", "darkslateblue",  "red3", "red3", "darkslateblue")) + theme_bw() + theme(legend.title = element_blank()) +
  scale_colour_manual(values = c("red3", "darkslateblue"), labels = c("post-fire", "pre-fire")) + 
  geom_hline(yintercept=0, linetype="dashed") +
  geom_vline(xintercept=0, linetype="dashed") +
  geom_text(vjust=-.5, label=(matrix$sites)) +
  guides(color = guide_legend(override.aes = list(size = 3))) + theme(legend.text=element_text(size=12))

#screeplot with broomstick model 
screeplot(plants.pca, bstick = TRUE, type = "lines")

#check for multicollinearity
cor(matrix[,-1:-2])

#high correlation between Atriplex and Schismus. run again remove atriplex
plants_no_atri <- plants_native %>% 
  filter(genus != "Atriplex")
plants_no_atri <- union(plants_no_atri, plants_invasive)

matrix.na <- plants_no_atri %>%
  filter(n_years > -5, n_years < 5) %>%
  select(c(fireID, genus, pre_or_post)) %>% 
  rename(sites = fireID) %>%  
  group_by(sites, genus, pre_or_post) %>% 
  summarize(abundance = n()) %>% 
  spread(genus, abundance)
  
#view(matrix)

#replace NA with 0
matrix.na[is.na(matrix.na)] <- 0

noatri.pca <- rda(matrix.na[,-1:-2])

#remove atriplex (native plant species; already have more native species than invasives)

#
summary(noatri.pca)

noatri.pca <- prcomp(matrix.na[3:8], scale = FALSE)

autoplot(noatri.pca, data=matrix.na, colour = "pre_or_post", loadings = TRUE, 
         loadings.label = TRUE, loadings.label.size = 3,loadings.label.vjust = c(0, 1.2, 1, 1.3, 1, 0), loadings.label.hjust = c(-0.1, 0, -0.2, 0, -0.2, 0.6), legend.title = "none") + 
  geom_point(size = 3, colour = c("red3", "darkslateblue",  "red3", "darkslateblue",  "red3", "red3", "darkslateblue")) + theme_bw() + theme(legend.title = element_blank()) +
  scale_colour_manual(values = c("red3", "darkslateblue"), labels = c("post-fire", "pre-fire")) + 
  geom_hline(yintercept=0, linetype="dashed") +
  geom_vline(xintercept=0, linetype="dashed") +
  geom_text(vjust=-.5, label=(matrix.na$sites)) +
  guides(color = guide_legend(override.aes = list(size = 3))) + theme(legend.text=element_text(size=12))

screeplot(noatri.pca, bstick = TRUE, type = "lines")
```

``` {r}
sites <- read_csv("data/sites.csv") %>% 
  filter(fireYear <= 2017)
observations <- read_csv("data/observations.csv")

data1 <- left_join(observations, sites, by = "fireID") %>% 
  filter(obsYear <=2020, obsYear >= 1995) %>% 
  filter(fireYear <= 2017)


data1$fireID <- as.character(data1$fireID)


head(data1)

```

## Pre-/Post- value

To compare observation before a fire and after a fire, create a pre-/post- column that identifies the observation as occurring either before a fire or after a fire. 

"postingvalue" = obsYear - fireYear
"pre_or_post" = if postingvalue is negative = pre; positive = post; 0 = SY\
those in the same year will be further catergorized by comparing the month of the observation.
"n_years" = absolute value of years between observation and fire



```{r}
data1 <- data1 %>% 
  mutate(postingvalue = obsYear - fireYear, 
         pre_or_post = case_when(postingvalue > 0 ~ "post",
                                 postingvalue < 0 ~ "pre",
                                 postingvalue == 0 ~ "SY"),
         n_years = abs(postingvalue))
  
#find pre- post- for observations in the same year and replace SY in datafire with pre or post
SY <- filter(data1, postingvalue == 0) %>% 
  mutate(postingmonth = month - fireMonth,
    pre_or_post = case_when(postingmonth >0 ~ "post",
                            postingmonth < 0 ~ "pre",
                            postingvalue == 0 ~ "SM"))

data1$pre_or_post <- ifelse(data1$pre_or_post == "SY", SY$pre_or_post, data1$pre_or_post)

unique(data1$pre_or_post) #check if any SM (same month); would need to further categorize

# need atleast 1 observation pre and 1 observation post
 one_each <- group_by(data1, fireID, pre_or_post) %>%
   summarize(total = n())

 one_each <- one_each %>%
   spread(pre_or_post, total) %>%
   mutate(post = ifelse(is.na(post), 0, post), pre = ifelse(is.na(pre), 0, pre)) %>%
   filter(post > 0 & pre > 0)

test <- one_each$fireID

#filter only that that have observations before and after a fire
data1 <- data1 %>%
  filter(fireID %in% test)
```


```{r}
skim(data1)
```

Compare pre to post

```{r}
ggplot(data1, aes(reorder(pre_or_post, totalObs), totalObs)) +
  geom_violin(fill = "grey75") +
  geom_boxplot(alpha = 0.5, width = 0.1) + 
  stat_summary(fun.y=mean, geom="point", shape=18, size=5, color="red", fill="red") +
  xlab("") +
  ylab("Total Occurrences") +
  theme_bw(base_size = 20)

stats <- data1 %>% group_by(pre_or_post) %>% 
  summarize(mean = mean(totalObs), min = min(totalObs),
            max = max(totalObs))
stats
```

observations over the years

```{r}

posting <- data1 %>% 
  group_by(fireID, postingvalue, pre_or_post, n_years, desert, class) %>% 
  filter(postingvalue >-6, postingvalue <6) %>% 
  summarize(total = n())

mean(posting$total)
var(posting$total)


model1 <- glm(total ~ postingvalue, family = "quasipoisson", posting)
model2 <- glm(total ~ postingvalue + desert, family = "quasipoisson", posting)
model3 <- glm(total ~ postingvalue + desert + class, family = "quasipoisson", posting)

summary(model1)
summary(model2)
summary(model3)

ggplot(posting, aes(postingvalue, total, color = pre_or_post)) + 
  geom_point() + 
  geom_smooth(method = "glm", method.args = list(family = "quasipoisson")) +
  ylab("Total occurrences") +
  xlab("Posting value") +
  scale_color_manual(values = c("red3", "blue4")) +
  theme_bw(base_size = 20) + theme(legend.title = element_blank())

```

