---
title: "index_recovery"
author: "Marina"
date: '2022-12-18'
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
---
##### load packages and data
{code not included}
```{r packages, message=FALSE, include=FALSE}
library(tidyverse)
library(mgcv)
library(sf)
#library(lwgeom)
library(lme4)
library(ggsci)
#library(ggrepel)
library(stats)
#library(broom)
#library(gghighlight)
library(gamm4)
#library(MuMIn)
library(cowplot)
library(MASS) #for glm.nb
library(pscl) #for zero-inflated glm
library(lmtest) #for lrtest: likelihood test of nested models
#library(VGAM) #for zero-truncated models
#library(countreg) #for zero-truncated models
library(glmmTMB) #glmm with zero-truncated nb
library(DHARMa) #diagnostic for mixed regression models
library(emmeans)
library(remote)
library(SpadeR)

setwd("~/GitHub/desert-fires-impact-biodiversity")

##code for data below
animals <- read_csv("~/GitHub/desert-fires-impact-biodiversity/data/csv-for-r/animals.csv")
data_pp <- read_csv("~/GitHub/desert-fires-impact-biodiversity/data/csv-for-r/data_pre-post.csv")
```

``` {r data, include=FALSE, eval=FALSE}

sm_mam <- c("Ammospermophilus", "Xerospermophilus", "Dipodomys", "Vulpes")
raptors  <- c("Accipitriformes", 'Pelecaniformes', "Strigiformes", "Falconiformes")

animals <- st_read("shapefiles/animals/animals_51022.shp") %>% 
  st_drop_geometry() %>% 
  rename(obsID = TARGET_FID, order = order_, 
         individualCount = individual, obsDay = day, 
         obsMonth = month, obsYear = year, 
         institutionalCode = institutio, 
         treatmentGroup = treatmentG, fireName = INCIDENT, 
         fireYear = FIRE_YEARn, fireSize = GISAcres) %>% 
  dplyr::select(-c("verbatimSc", "issue", "coordinate", 'nearRd_FID', "nearUA_FID", 
            'basisOfRec', 'institutionalCode', 'collection', 'recordedBy', 'nearRdDist', 'nearUADist')) %>% 
  filter(obsYear > 1994, obsYear < 2021, species != "Canis lupus", species != "Balaenoptera musculus", 
         species != "Grus canadensis", treatmentGroup != "burned prior 2000") %>%  
  mutate(funcGroup =
                     ifelse(genus == "Puma" | genus == "Ovis", "Large Mammals",
                            ifelse(genus == "Branchinecta" | genus == "Cyprinodon", "Aquatic",
                            ifelse(genus == "Dinacoma", "Beetles",
                            ifelse(genus == "Bombus", "Bees",
                            ifelse(genus == "Gopherus", "Tortoises",
                            ifelse(genus == "Danaus" | genus == "Euproserpinus", "Butterflies & Moths",
                            ifelse(genus == "Rana" | genus == "Anaxyrus","Frogs and Toads",
                            ifelse(genus == "Ambystoma" | genus == "Batrachoseps", "Salamanders",
                            ifelse(genus == "Coleonyx" | genus == "Gambelia" | genus == "Uma", "Lizards and Geckos",
                            ifelse(genus %in% sm_mam, "Small Mammals",
                            ifelse(order %in% raptors, "Birds:Raptors",
                            ifelse(order == "Passeriformes", "Birds:Passerines",
                            ifelse(order == "Piciformes", "Birds:Woodpeckers",
                            ifelse(order == "Gruiformes" | order == "Anseriformes", "Birds:Rails and Geese", "ERROR"
                                   )))))))))))))),
         ez_taxa = ifelse(class=='Aves', 'Aves', 'Other'),
         individualCount = ifelse(individualCount == 0, 1, individualCount))


ndvi <- read_csv("data/ndvi.csv")
areas <- read.csv('data/areas.csv')
sites <- read_csv("data/sites.csv")


data2a <- animals %>%
  group_by(obsYear, funcGroup, ez_taxa, treatmentGroup, desert) %>% 
  summarize(totalObs = sum(individualCount))

data <- data.frame(obsYear = rep(1995:2020, each = 84),
                    desert = rep(rep(c("Mojave", "San Joaquin", "Sonoran"), each = 2), times = 364),
                    treatmentGroup = rep(rep(c("burned", "never burned"), times = 42), times = 26),
                    funcGroup = rep(rep(c("Large Mammals", "Aquatic","Beetles", "Bees", "Tortoises",
                                                "Butterflies & Moths", "Frogs and Toads", "Salamanders",
                                                "Lizards and Geckos", "Small Mammals", "Birds:Raptors",
                                                "Birds:Passerines", "Birds:Woodpeckers", 
                                                "Birds:Rails and Geese"), each = 6), times = 26))%>% 
  left_join(., ndvi, by = c("desert", "obsYear", "treatmentGroup")) %>% #add ndvi
  left_join(., areas, by = c("desert", "treatmentGroup")) %>% #add area
  left_join(., data2a, by = c("desert", "obsYear", "treatmentGroup", "funcGroup")) %>% #add data 
  mutate(ez_taxa = ifelse(startsWith(funcGroup, "Birds"), "Aves", "Other")) %>% #category Aves and Other
  mutate(totalObs = ifelse(is.na(totalObs), 0, totalObs)) %>%  # Total Obs NA -> 0 
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2, #standardize observations
         desert = as.factor(desert),
         treatmentGroup = factor(ifelse(startsWith(treatmentGroup, "never"), "Control", "Burned"), 
                                 levels = c( "Control", "Burned")),
         funcGroup = as.factor(funcGroup),
         ez_taxa = as.factor(ez_taxa),
         stzdTotalObs_rounded = ceiling(stzd_totalObs))

data_2000 <- filter(data, obsYear > 1999) # filter out anything before 2000 since no NDVI info

write_csv(animals, "~/GitHub/desert-fires-impact-biodiversity/data/csv-for-r/animals.csv")

```
```{r prepare recovery data, include = FALSE, eval=FALSE}



burned <- animals %>% 
  filter(treatmentGroup == "burned") %>% 
  merge(.,sites[,c("fireID", "fireMonth")], by = "fireID") %>% #NEED to add fire months
  mutate(yearsSinceFire = obsYear - fireYear, 
         pre_or_post = case_when(yearsSinceFire > 0 ~ "post",
                                 yearsSinceFire < 0 ~ "pre",
                                 yearsSinceFire == 0 ~ "SY"),
         n_years = abs(yearsSinceFire))

#find pre- post- for observations in the same year and replace SY in datafire with pre or post
SY <- filter(burned, yearsSinceFire == 0) %>% 
  mutate(postingmonth = obsMonth - fireMonth,
         pre_or_post = case_when(postingmonth >0 ~ "post",
                                 postingmonth < 0 ~ "pre",
                                 yearsSinceFire == 0 ~ "SM")) %>% 
  dplyr::select(-postingmonth)

burned <- burned %>% filter(pre_or_post != "SY") %>% 
  rbind(., SY)

unique(burned$pre_or_post) #check if any SM (same month); would need to further categorize

burned <- left_join(burned, ndvi, by = c("desert", "obsYear", "treatmentGroup"))
```
```{r data for pre-/post- all, include=FALSE, eval=FALSE}
###data for pre-/post- burned sites ALL
data_pp_b1 <-  burned %>% 
  filter(n_years <=5) %>% 
  dplyr::select(c("ez_taxa", "funcGroup", "individualCount", 
                  "obsYear", "desert", "fireID", 
                  "fireName", "fireYear", "fireMonth", 
                  "yearsSinceFire", "pre_or_post", "n_years", "ndvi")) %>% 
  group_by(desert, obsYear, fireID, 
           fireYear, yearsSinceFire, 
           ez_taxa, funcGroup, 
           pre_or_post, n_years, ndvi) %>% 
  summarize(totalObs = n()) %>% 
  left_join(., filter(areas, treatmentGroup == "burned"), by = "desert") %>% #add area
  mutate(stzdObs = ceiling((totalObs/area_km2)*10000)) %>% 
  ungroup() %>% group_by(desert) 

unique(data_pp_b1$funcGroup)

### add zeros for years with no occurrences reported
fireYear <- data_pp_b1 %>% 
  filter(n_years <=5) %>% 
  group_by(fireYear, desert, fireID) %>% 
  summarize(total = n()) %>% 
  dplyr::select(-total) %>% 
  filter(fireYear <= 2015)

#repeats each 8 functional groups * 11 years for -5 to +5
data_pp_b2 <- data.frame(rep(fireYear$fireYear, each = (length(unique(data_pp_b1$funcGroup)) * 11)), 
                         rep(fireYear$desert, each = (length(unique(data_pp_b1$funcGroup)) * 11)), 
                         rep(fireYear$fireID, each = (length(unique(data_pp_b1$funcGroup)) * 11)), 
                         rep ((unique(data_pp_b1$funcGroup)), 
                              each = 11, times = nrow(fireYear)))

names(data_pp_b2)[1] <- "fireYear"
names(data_pp_b2)[2] <- "desert"
names(data_pp_b2)[3] <- "fireID"
names(data_pp_b2)[4] <- "funcGroup"

#second column = list of +/- since fire / from -5 to +5
data_pp_b2$yearsSinceFire<- rep(-5:5, nrow(fireYear))

#make a column with obsYear
data_pp_b2 <- data_pp_b2 %>% mutate(obsYear = fireYear + yearsSinceFire)

#merge the occurrences for burn sites with the data frame created and replace with zeros when no occurrences were reported
data_pp_b2<- left_join(data_pp_b2, data_pp_b1, 
                       by = c("desert", "obsYear", "fireYear", "fireID", "yearsSinceFire", "funcGroup")) %>% 
  filter(yearsSinceFire != 0 | yearsSinceFire == 0 & !is.na(pre_or_post)) %>% 
  mutate(treatmentGroup = ifelse(is.na(treatmentGroup), "burned", treatmentGroup),
         pre_or_post = ifelse(is.na(pre_or_post), case_when(yearsSinceFire > 0 ~ "post",
                                                            yearsSinceFire < 0 ~ "pre",
                                                            yearsSinceFire == 0 ~ "same year"), pre_or_post))

###data for pre-/post- control sites###

#first column = list of fireYear
###old code
# fireYear <- data_pp_b %>% filter(n_years <=5) %>% {unique(.$fireYear)} %>% sort() %>% rep(.,each=11)


data_c <- data.frame(rep(fireYear$fireYear, each = (length(unique(data_pp_b1$funcGroup)) * 11)), 
                     rep(fireYear$desert, each = (length(unique(data_pp_b1$funcGroup)) * 11)), 
                     rep((unique(data_pp_b1$funcGroup)), each = 11, times = nrow(fireYear)))

names(data_c)[1] <- "fireYear"
names(data_c)[2] <- "desert"
names(data_c)[3] <- "funcGroup"

#second column = list of +/- since fire / from -5 to +5
data_c$yearsSinceFire<- rep(-5:5, nrow(fireYear))

#make a column with obsYear
data_c <- data_c %>% mutate(obsYear = fireYear + yearsSinceFire)


totalObs <- animals %>% 
  filter(treatmentGroup == "never burned") %>% 
  group_by(obsYear, desert, ez_taxa, funcGroup) %>% 
  summarize(totalObs = n())

data_c <- merge(data_c, totalObs) %>% mutate(pre_or_post = case_when(yearsSinceFire > 0 ~ "post",
                                                                     yearsSinceFire < 0 ~ "pre",
                                                                     yearsSinceFire == 0 ~ "same year")) %>% 
  left_join(., filter(ndvi, treatmentGroup == "never burned"), by = c("desert", "obsYear")) %>%#add ndvi
  dplyr::select(-treatmentGroup) %>% 
  left_join(., filter(areas, treatmentGroup == "never burned"), by = "desert") %>% #add area
  mutate(stzdObs = ceiling((totalObs/area_km2)*10000), treatmentGroup = "control",
         n_years = abs(yearsSinceFire),
         fireID = NA) %>% 
  filter(yearsSinceFire != 0)

data_pp <- rbind(data_pp_b2, data_c) %>% 
  mutate(pre_or_post = factor(pre_or_post, levels = c( "pre", "post")), 
         treatmentGroup = factor(treatmentGroup, levels = c("control", "burned")),
         desert = as.factor(desert),
         totalObs = ifelse(is.na(totalObs), 0, totalObs),
         stzdObs = ifelse(is.na(stzdObs), 0, stzdObs)) # Total Obs NA -> 0 )

write_csv(data_pp, "~/GitHub/desert-fires-impact-biodiversity/data/csv-for-r/data_pre-post.csv")
```

## Occurrences before and after fire
### GLMM model w/ emmeans - pre/post

#### passerine and raptor only
```{r stats on pass/rapt recovery}
data_pp_5yrPR <- filter(data_pp, funcGroup == "Birds:Passerines" | funcGroup == "Birds:Raptors") %>% 
  group_by(desert, fireYear, pre_or_post, funcGroup, treatmentGroup, fireID) %>% 
  summarize(mean_occurrence = ceiling(mean(stzdObs)))

pp_nbPR <- glmmTMB(mean_occurrence ~ pre_or_post + treatmentGroup + funcGroup + (1|desert), family = nbinom1, data = data_pp_5yrPR)

#stepwise regression to select best predictors; both summary above and stepAIC show that funcGroup not significant
null <- glmmTMB(mean_occurrence ~ 1, family = nbinom1, data = data_pp_5yrPR)
stepAIC(pp_nbPR, scope=list(lower=null, upper=pp_nbPR), data=data_pp_5yr, direction='backward')

pp_nbPR <- glmmTMB(mean_occurrence ~ pre_or_post*treatmentGroup + funcGroup + (1|desert), family = nbinom1, data = data_pp_5yrPR)

#validate model using simulated residuals 
simulationOutput <- simulateResiduals(fittedModel = pp_nbPR, plot = F)
#plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)

summary(pp_nbPR)

emm_pp <- emmeans(pp_nbPR, pairwise ~ pre_or_post + treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbPR, pairwise ~ treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbPR, pairwise ~ pre_or_post|treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbPR, pairwise ~ treatmentGroup|pre_or_post)
summary(emm_pp)

```

#### all aves
```{r stats on all aves recovery}
data_pp_5yrA <- filter(data_pp, grepl("Birds", funcGroup)) %>% 
  group_by(desert, fireYear, pre_or_post, funcGroup, treatmentGroup, fireID) %>% 
  summarize(mean_occurrence = ceiling(mean(stzdObs)))

pp_nbA <- glmmTMB(mean_occurrence ~ pre_or_post*treatmentGroup + funcGroup + (1|desert), family = nbinom1, data = data_pp_5yrA)

#validate model using simulated residuals 
simulationOutput <- simulateResiduals(fittedModel = pp_nbA, plot = F)
#plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)

summary(pp_nbA)

#stepwise regression to select best predictors; both summary above and stepAIC show that funcGroup not significant
null <- glmmTMB(mean_occurrence ~ 1, family = nbinom1, data = data_pp_5yrA)
stepAIC(pp_nbA, scope=list(lower=null, upper=pp_nbA), data=data_pp_5yrA, direction='backward')

emm_pp <- emmeans(pp_nbA, pairwise ~ pre_or_post + treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbA, pairwise ~ pre_or_post|funcGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbA, pairwise ~ treatmentGroup|funcGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbA, pairwise ~ treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbA, pairwise ~ pre_or_post|treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbA, pairwise ~ treatmentGroup|pre_or_post)
summary(emm_pp)

```

#### non-avian species
```{r stats on other recovery}
data_pp_5yrNA <- filter(data_pp, !grepl("Birds", funcGroup)) %>% 
  group_by(desert, fireYear, pre_or_post, funcGroup, treatmentGroup, fireID) %>% 
  summarize(mean_occurrence = ceiling(mean(stzdObs)))

pp_nbNA <- glmmTMB(mean_occurrence ~ pre_or_post*treatmentGroup + funcGroup + (1|desert), family = nbinom1, data = data_pp_5yrNA)

#validate model using simulated residuals 
simulationOutput <- simulateResiduals(fittedModel = pp_nbNA, plot = F)
#plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
                  
summary(pp_nbNA)


#stepwise regression to select best predictors; both summary above and stepAIC show that funcGroup not significant
null <- glmmTMB(mean_occurrence ~ 1, family = nbinom1, data = data_pp_5yrNA)
stepAIC(pp_nbNA, scope=list(lower=null, upper=pp_nbNA), data=data_pp_5yr_aves, direction='backward')

pp_nbNA <- glmmTMB(mean_occurrence ~ pre_or_post*treatmentGroup +  (1|desert), family = nbinom2, data = data_pp_5yrNA)


emm_pp <- emmeans(pp_nbNA, pairwise ~ pre_or_post + treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbNA, pairwise ~ pre_or_post|funcGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbNA, pairwise ~ treatmentGroup|funcGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbNA, pairwise ~ treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbNA, pairwise ~ pre_or_post|treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbNA, pairwise ~ treatmentGroup|pre_or_post)
summary(emm_pp)
```

#### all species
```{r stats on all recovery}
data_pp_5yrAS <- data_pp %>% 
  group_by(desert, fireYear, pre_or_post, funcGroup, treatmentGroup, fireID) %>% 
  summarize(mean_occurrence = ceiling(mean(stzdObs))) %>% 
  mutate(ez_taxa = ifelse(grepl("Birds", funcGroup), "Aves", "Other"))

pp_nbAS <- glmmTMB(mean_occurrence ~ pre_or_post*treatmentGroup + ez_taxa + (1|desert), family = nbinom2, data = data_pp_5yrAS)

#validate model using simulated residuals 
simulationOutput <- simulateResiduals(fittedModel = pp_nbAS, plot = F)
plot(simulationOutput)
testOverdispersion(simulationOutput)
testZeroInflation(simulationOutput)

summary(pp_nbAS)


#stepwise regression to select best predictors; both summary above and stepAIC show that funcGroup not significant
null <- glmmTMB(mean_occurrence ~ 1, family = nbinom1, data = data_pp_5yrAS)
stepAIC(pp_nbAS, scope=list(lower=null, upper=pp_nbAS), data=data_pp_5yrAS, direction='backward')

emm_pp <- emmeans(pp_nbAS, pairwise ~ pre_or_post + treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbAS, pairwise ~ treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbAS, pairwise ~ pre_or_post|treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nbAS, pairwise ~ treatmentGroup|pre_or_post)
summary(emm_pp)
```

### graphs
Overall occurrences of raptors and passerines between 1995-2020

```{r prepost passerines & raptors, echo = FALSE}
#occurrences for raptors and passerines
ggplot(filter(data_pp, funcGroup == "Birds:Passerines" | funcGroup == "Birds:Raptors"), aes(x = treatmentGroup, y =  stzdObs, fill = factor(pre_or_post, levels = c("pre", "post")))) +
  geom_boxplot()+
  scale_fill_aaas(labels = c("Before fire", "After fire")) +
  #scale_x_discrete(labels = c("Burned", "Control")) +
  theme(legend.title = element_blank()) +
  xlab("Treatment Group") +
  ylab(bquote("Bird occurrences reported per 10,000 km"^2)) +
  facet_grid(vars(funcGroup),vars(desert))
```

The average number of occurrences reported 5 years before fire and 5 years after fire. Zeros were added to years when no occurrences were reported.

```{r pre-post- pass/rapt 5yr average, echo = FALSE}
#mean occurrences 5yrs before and after fire
ggplot(data_pp_5yrPR, aes(x = treatmentGroup, y =  mean_occurrence, fill = factor(pre_or_post, levels = c("pre", "post")))) +
  geom_boxplot()+
  scale_fill_aaas(labels = c("Before fire", "After fire")) +
  #scale_x_discrete(labels = c("Burned", "Control")) +
  theme(legend.title = element_blank()) +
  xlab("Treatment Group") +
  ylab(bquote("5-yr average of passerines and raptors \noccurrences reported per 10,000 km"^2)) +
  facet_grid(vars(funcGroup),vars(desert))

```
```{r pre-post- all aves 5yr avg, echo = FALSE}
#mean occurrences 5yrs before and after fire
ggplot(data_pp_5yrA, aes(x = treatmentGroup, y =  mean_occurrence, fill = factor(pre_or_post, levels = c("pre", "post")))) +
  geom_boxplot()+
  scale_fill_aaas(labels = c("Before fire", "After fire")) +
  #scale_x_discrete(labels = c("Burned", "Control")) +
  theme(legend.title = element_blank()) +
  xlab("Treatment Group") +
  ylab(bquote("5-yr average of all bird occurrences reported per 10,000 km"^2)) +
  facet_grid(vars(funcGroup),vars(desert))

```
```{r pre-post- other 5yr avg, echo = FALSE}
#mean occurrences 5yrs before and after fire

ggplot(data_pp_5yrNA, aes(x = treatmentGroup, y =  mean_occurrence, fill = factor(pre_or_post, levels = c("pre", "post")))) +
  geom_boxplot()+
  scale_fill_aaas(labels = c("Before fire", "After fire")) +
  #scale_x_discrete(labels = c("Burned", "Control")) +
  theme(legend.title = element_blank()) +
  xlab("Treatment Group") +
  ylab(bquote("5-yr average of non-avian ES occurrences reported per 10,000 km"^2)) +
  facet_grid(vars(desert))
```
```{r pre-post- all 5yr avg, echo = FALSE}
#mean occurrences 5yrs before and after fire

ggplot(data_pp_5yrAS, aes(x = treatmentGroup, y =  mean_occurrence, fill = factor(pre_or_post, levels = c("pre", "post")))) +
  geom_boxplot()+
  scale_fill_aaas(labels = c("Before fire", "After fire")) +
  #scale_x_discrete(labels = c("Burned", "Control")) +
  theme(legend.title = element_blank()) +
  xlab("Treatment Group") +
  ylab(bquote("5-yr average of all occurrences reported per 10,000 km"^2)) +
  facet_grid(vars(desert))
```

## Recovery over-time - manual
```{r data for over-time, include=FALSE}

###data for over-time for burned sites
burned <- animals %>% 
  filter(treatmentGroup == "burned") %>% 
  merge(.,sites[,c("fireID", "fireMonth")], by = "fireID") %>% #NEED to add fire months
  mutate(yearsSinceFire = obsYear - fireYear, 
         pre_or_post = case_when(yearsSinceFire > 0 ~ "post",
                                 yearsSinceFire < 0 ~ "pre",
                                 yearsSinceFire == 0 ~ "SY"),
         n_years = abs(yearsSinceFire))

#find pre- post- for observations in the same year and replace SY in datafire with pre or post
SY <- filter(burned, yearsSinceFire == 0) %>% 
  mutate(postingmonth = obsMonth - fireMonth,
         pre_or_post = case_when(postingmonth >0 ~ "post",
                                 postingmonth < 0 ~ "pre",
                                 yearsSinceFire == 0 ~ "SM")) %>% 
  dplyr::select(-postingmonth)

burned <- burned %>% filter(pre_or_post != "SY") %>% 
  rbind(., SY)

unique(burned$pre_or_post) #check if any SM (same month); would need to further categorize

burned <- burned %>% 
  filter(pre_or_post == "post") %>% 
  dplyr::select(c("desert", "obsYear", "fireYear", "species",
                  "yearsSinceFire")) %>% 
  mutate(count = 1) %>% 
  mutate(yearsSinceFire = ifelse(yearsSinceFire == 0, 1, yearsSinceFire))

### get fire years to make control
fireYear <- burned %>% 
  group_by(fireYear, desert) %>% 
  summarize(total = n()) %>% 
  dplyr::select(-total) 

### make control
control <- burned %>% group_by(desert, fireYear) %>% 
  summarize(maxTime = max(yearsSinceFire)) %>% 
  filter(maxTime != 0)

### get species info for control
control_species <- animals %>% 
  filter(treatmentGroup == "never burned", obsYear > 1999) %>% 
  group_by(desert, obsYear, species) %>%
  summarize(count = n()) 

### how many species each year in control?

control_sp_total <- control_species %>% 
  group_by(desert, obsYear) %>%
  summarize(count = n())


  
## vectors for control df
yearsSinceFire <- c()
desert <- c()
fireYear <- c()


for (i in 1:nrow(control)) {
  yearsSinceFire <-  c(yearsSinceFire, rep(1:control$maxTime[i], 1))
}

for (i in 1:nrow(control)) {
  desert <-  c(desert, rep(control$desert[i], each = control$maxTime[i]))
}

for (i in 1:nrow(control)) {
  fireYear <-  c(fireYear, rep(control$fireYear[i], each = control$maxTime[i]))
}


control <- data.frame(desert, fireYear, yearsSinceFire) %>% 
  mutate(obsYear = fireYear + yearsSinceFire) %>% 
  filter(obsYear < 2021) %>% 
  left_join(., dplyr::select(control_species, -count), by = c("obsYear", "desert"))

## make df with just desert, TSF, and species for both burned and control sites

burned <- burned %>% group_by(desert, yearsSinceFire, species) %>% 
  summarize(count = n()) %>% 
  dplyr::select(-count)

control <- control %>% group_by(desert, yearsSinceFire, species) %>% 
  summarize(count = n()) %>% 
  dplyr::select(-count)

unique_b <- anti_join(burned, control) %>% 
  group_by(desert, yearsSinceFire) %>% 
  summarize(unique_b = n())

unique_c <- anti_join(control, burned) %>% 
  group_by(desert, yearsSinceFire) %>% 
  summarize(unique_c = n())

shared <- anti_join(burned, anti_join(burned, control)) %>% 
  group_by(desert, yearsSinceFire) %>% 
  summarize(shared = n())

tsf_df <- full_join(shared, unique_b, by = c("desert", "yearsSinceFire")) %>% 
  full_join(., unique_c, by = c("desert", "yearsSinceFire")) %>% 
  mutate(unique_b = ifelse(is.na(unique_b), 0, unique_b),
         shared = ifelse(is.na(shared), 0, shared),
         unique_c = ifelse(is.na(unique_c), 0, unique_c),
         si = (2*shared)/(shared +unique_b + unique_c))

print(tsf_df)

```
```{r graph for over-time recovery}
ggplot(data = tsf_df, aes(x = yearsSinceFire, y = si, color = desert)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  ylab("Sorensen's Similarity Index")
```
 
```{r}

hist(x = tsf_df$si)
shapiro.test(tsf_df$si)

tsf_mod <- lm(si ~ yearsSinceFire + desert, data = tsf_df)
summary(tsf_mod)

plot(tsf_mod)



```
 
 
 
 
## Recovery over-time - SpadeR
```{r SpadeR data matrix, include = FALSE, eval = FALSE}
###data for over time for burned sites
burned <- animals %>% 
  filter(treatmentGroup == "burned") %>% 
  merge(.,sites[,c("fireID", "fireMonth")], by = "fireID") %>% #NEED to add fire months
  mutate(yearsSinceFire = obsYear - fireYear, 
         pre_or_post = case_when(yearsSinceFire > 0 ~ "post",
                                 yearsSinceFire < 0 ~ "pre",
                                 yearsSinceFire == 0 ~ "SY"),
         n_years = abs(yearsSinceFire))

#find pre- post- for observations in the same year and replace SY in datafire with pre or post
SY <- filter(burned, yearsSinceFire == 0) %>% 
  mutate(postingmonth = obsMonth - fireMonth,
         pre_or_post = case_when(postingmonth >0 ~ "post",
                                 postingmonth < 0 ~ "pre",
                                 yearsSinceFire == 0 ~ "SM")) %>% 
  dplyr::select(-postingmonth)

burned <- burned %>% filter(pre_or_post != "SY") %>% 
  rbind(., SY)

unique(burned$pre_or_post) #check if any SM (same month); would need to further categorize

#filter out only post fire observations
#### only sums the area of burned sites where any detection was reported. burned areas with no
#### observations reported are EXCLUDED (counted as unsampled)
su_ex <- burned %>% filter(pre_or_post == "post") %>% 
  dplyr::select(c("fireID", "desert", "fireName", "area_km2", "yearsSinceFire")) %>% 
  mutate(yearsSinceFire = ifelse(yearsSinceFire == 0, 1, yearsSinceFire)) %>% 
  group_by(fireID, desert, fireName, yearsSinceFire, area_km2) %>% 
  summarize(area_km2 = mean(area_km2)) %>% 
  group_by(desert, yearsSinceFire) %>% 
  summarize(area_km2 = sum(area_km2))

#### sums the area of burned sites every progressing year. burned areas with no
#### observations reported are INCLUDED (counted as undetected)

### did not complete because did not think this was the appropriate approach. This would imply that all of the burned area (including fires burning  in different years) are including in the same 'year since fire' value

# su_in <- burned %>% filter(pre_or_post == "post") %>% 
#   dplyr::select(c("fireID", 'fireYear', "obsYear","yearsSinceFire","desert", "fireName", "area_km2")) %>% 
#   mutate(yearsSinceFire = ifelse(yearsSinceFire == 0, 1, yearsSinceFire)) %>%
#   group_by(fireID, fireYear, obsYear, desert, fireName, area_km2, yearsSinceFire) %>%
#   summarize(area_km2 = mean(area_km2)) 
# 
# 
# 
# su_in1 <-  su_in %>% group_by(fireID, fireYear, desert) %>%
#   summarize(area_km2 = mean(area_km2)) %>% 
#   group_by(fireYear, desert) %>% 
#   summarize(area_km2 = sum(area_km2))
# 
# su_in2 <- su_in %>% group_by(desert, obsYear, yearsSinceFire) %>% 
#   summarize(count = n()) %>% 
#   dplyr::select(-count)

  
burned <- burned %>% 
  filter(pre_or_post == "post") %>% 
  dplyr::select(c("desert", "obsYear", "fireYear", "species",
                  "yearsSinceFire")) %>% 
  mutate(yearsSinceFire = ifelse(yearsSinceFire == 0, 1, yearsSinceFire))

### get fire years to make control
fireYear <- burned %>% 
  group_by(fireYear, desert) %>% 
  summarize(total = n()) %>% 
  dplyr::select(-total) 

### make control
control <- burned %>% group_by(desert, fireYear) %>% 
  summarize(maxTime = max(yearsSinceFire)) %>% 
  filter(maxTime != 0)

### get species info for control
control_species <- animals %>% 
  filter(treatmentGroup == "never burned", obsYear > 1999) %>% 
  group_by(desert, obsYear, species) %>%
  summarize(count = n()) 

### how many species each year in control?

control_sp_total <- control_species %>% 
  group_by(desert, obsYear) %>%
  summarize(count = n())


  
## vectors for control df
yearsSinceFire <- c()
desert <- c()
fireYear <- c()


for (i in 1:nrow(control)) {
  yearsSinceFire <-  c(yearsSinceFire, rep(1:control$maxTime[i], 1))
}

for (i in 1:nrow(control)) {
  desert <-  c(desert, rep(control$desert[i], each = control$maxTime[i]))
}

for (i in 1:nrow(control)) {
  fireYear <-  c(fireYear, rep(control$fireYear[i], each = control$maxTime[i]))
}


control <- data.frame(desert, fireYear, yearsSinceFire) %>% 
  mutate(obsYear = fireYear + yearsSinceFire) %>% 
  filter(obsYear < 2021) %>% 
  left_join(., dplyr::select(control_species, -count), by = c("obsYear", "desert"))

## make df with just desert, TSF, and species for both burned and control sites

#sampling unit = areas
areas <- areas %>% mutate(treatmentGroup = ifelse(treatmentGroup == 'never burned', "control", treatmentGroup))

burned <- burned %>% group_by(desert, yearsSinceFire, species) %>% 
  summarize(count = n()) %>% 
  left_join(su_ex, by =  c("desert", "yearsSinceFire")) %>% 
  mutate(area_km2 = round(area_km2, digits = 0))

control <- control %>% group_by(desert, yearsSinceFire, species) %>% 
  summarize(count = n()) %>% 
  left_join(filter(areas, treatmentGroup == 'control'), by = 'desert') %>% 
  dplyr::select(-treatmentGroup) %>% 
  mutate(area_km2 = round(area_km2, digits = 0))

species <- c(unique(control_species$species), "Anaxyrus californicus")

desert <- c("Mojave", "San Joaquin", "Sonoran")

recoverytsf_list <- list()

df <- data.frame(species)

for (d in 1:3) {
  tsf_list <- list()
  loc <- desert[d]
  
  for (y in 1:20) {
  df <- data.frame(species)
  
  if (nrow(filter(burned, desert == loc, yearsSinceFire == y)) == 0) {
    next
  }
  
  spread1 <- burned %>%
    filter(desert == loc, yearsSinceFire == y) %>%
    mutate(area_km2 = ifelse(is.na(.[1,1]), 0, area_km2)) %>%
    spread(area_km2, count) %>%
    ungroup() %>% 
    dplyr::select(3:4)
    
  df <- left_join(df, spread1, by = "species")
    
  spread2 <- control %>% 
    filter(desert == loc, yearsSinceFire == y) %>% 
    ungroup() %>% 
    spread(area_km2, count) %>%
    dplyr::select(3:4)
    
  df <- left_join(df, spread2, by = "species")
  df <- mutate_if(df, is.numeric, ~replace_na(.,0))
  
  matrix <- rbind(matrix(as.integer(colnames(df[,2:3])), nrow = 1, ncol = 2), 
                  as.matrix(df[,2:3]))
  
  colnames(matrix) <- c("burned", "control")
  rownames(matrix) <- c("sampling unit", species)
  
  df <- as.data.frame(matrix) 
  
  tsf_list <- append(tsf_list, list(df))
  names(tsf_list)[length(tsf_list)] <- y
  }
  recoverytsf_list <- append(recoverytsf_list, list(tsf_list))
  
  names(recoverytsf_list)[d] <- desert[d]
  
}
```
```{r SpadeR data matrix SU is unique reports, include=FALSE}
burned <- animals %>% 
  filter(treatmentGroup == "burned") %>% 
  merge(.,sites[,c("fireID", "fireMonth")], by = "fireID") %>% #NEED to add fire months
  mutate(yearsSinceFire = obsYear - fireYear, 
         pre_or_post = case_when(yearsSinceFire > 0 ~ "post",
                                 yearsSinceFire < 0 ~ "pre",
                                 yearsSinceFire == 0 ~ "SY"),
         n_years = abs(yearsSinceFire))

#find pre- post- for observations in the same year and replace SY in datafire with pre or post
SY <- filter(burned, yearsSinceFire == 0) %>% 
  mutate(postingmonth = obsMonth - fireMonth,
         pre_or_post = case_when(postingmonth >0 ~ "post",
                                 postingmonth < 0 ~ "pre",
                                 yearsSinceFire == 0 ~ "SM")) %>% 
  dplyr::select(-postingmonth)

burned <- burned %>% filter(pre_or_post != "SY") %>% 
  rbind(., SY)

unique(burned$pre_or_post) #check if any SM (same month); would need to further categorize


### SU by occurrence reports
su <- burned %>% filter(pre_or_post == "post") %>% 
  mutate(yearsSinceFire = ifelse(yearsSinceFire == 0, 1, yearsSinceFire), 
         decimalLat = round(decimalLat, digits = 3), 
         decimalLon = round(decimalLon, digits = 3)) %>% 
  group_by(fireID, desert, decimalLat, decimalLon, eventDate, obsYear, yearsSinceFire) %>% 
  summarize(count = n()) %>% 
  group_by(desert, yearsSinceFire) %>% 
  summarize(su = n()) 


burned <- burned %>% 
  filter(pre_or_post == "post") %>% 
  dplyr::select(c("desert", "obsYear", "fireYear", "species",
                  "yearsSinceFire")) %>% 
  mutate(yearsSinceFire = ifelse(yearsSinceFire == 0, 1, yearsSinceFire))

### get fire years to make control
fireYear <- burned %>% 
  group_by(fireYear, desert) %>% 
  summarize(total = n()) %>% 
  dplyr::select(-total) 

### make control
control <- burned %>% group_by(desert, fireYear) %>% 
  summarize(maxTime = max(yearsSinceFire)) %>% 
  filter(maxTime != 0)

### get species info for control
control_species <- animals %>% 
  filter(treatmentGroup == "never burned", obsYear > 1999) %>% 
  group_by(desert, obsYear, species) %>%
  summarize(count = n()) 

### how many species each year in control?

control_sp_total <- control_species %>% 
  group_by(desert, obsYear) %>%
  summarize(count = n())


  
## vectors for control df
yearsSinceFire <- c()
desert <- c()
fireYear <- c()


for (i in 1:nrow(control)) {
  yearsSinceFire <-  c(yearsSinceFire, rep(1:control$maxTime[i], 1))
}

for (i in 1:nrow(control)) {
  desert <-  c(desert, rep(control$desert[i], each = control$maxTime[i]))
}

for (i in 1:nrow(control)) {
  fireYear <-  c(fireYear, rep(control$fireYear[i], each = control$maxTime[i]))
}


control <- data.frame(desert, fireYear, yearsSinceFire) %>% 
  mutate(obsYear = fireYear + yearsSinceFire) %>% 
  filter(obsYear < 2021) %>% 
  left_join(., control_species, by = c("obsYear", "desert"))

## make df with just desert, TSF, and species for both burned and control sites

#sampling unit = # of unique reportings
burned <- burned %>% group_by(desert, yearsSinceFire, species) %>% 
  summarize(count = n()) %>% 
  left_join(su, by =  c("desert", "yearsSinceFire"))

control_su <- animals %>% 
  filter(treatmentGroup == "never burned", obsYear > 1999) %>%
  mutate(decimalLat = round(decimalLat, digits = 3), decimalLon = round(decimalLon, digits = 3)) %>% 
  group_by(desert, decimalLat, decimalLon, eventDate, obsYear) %>%
  summarize(count = n()) %>% #unique sampling units by location and date; anything within 360ft on the same date is counted as one sampling unit
  group_by(desert, obsYear) %>% 
  summarize(su = n()) #sum up sampling units for each year; each reported occurrence is one sampling unit

control_su2 <- control %>% 
  left_join(control_su, by = c("desert", "obsYear")) %>% 
  group_by(desert, yearsSinceFire, obsYear, su) %>% 
  summarize(su = mean(su)) %>%
  group_by(desert, yearsSinceFire) %>% 
  summarize(su = sum(su))

control <- control %>% 
  left_join(control_su2, by = c("desert", "yearsSinceFire")) %>% 
  group_by(desert, yearsSinceFire, species, su) %>% 
  summarize(count = sum(count)) 
  
species <- c(unique(control_species$species), "Anaxyrus californicus")

desert <- c("Mojave", "San Joaquin", "Sonoran")

recoverytsf_list <- list()

df <- data.frame(species)

for (d in 1:3) {
  tsf_list <- list()
  loc <- desert[d]
  
  for (y in 1:20) {
  df <- data.frame(species)
  
  if (nrow(filter(burned, desert == loc, yearsSinceFire == y)) == 0) {
    next
  }
  
  spread1 <- burned %>%
    filter(desert == loc, yearsSinceFire == y)%>%
    spread(su, count) %>%
    ungroup() %>% 
    dplyr::select(3:4)
    
  df <- left_join(df, spread1, by = "species")
    
  spread2 <- control %>% 
    filter(desert == loc, yearsSinceFire == y) %>% 
    ungroup() %>% 
    spread(su, count) %>%
    dplyr::select(3:4)
    
  df <- left_join(df, spread2, by = "species")
  df <- mutate_if(df, is.numeric, ~replace_na(.,0))
  
  matrix <- rbind(matrix(as.integer(colnames(df[,2:3])), nrow = 1, ncol = 2), 
                  as.matrix(df[,2:3]))
  
  colnames(matrix) <- c("burned", "control")
  rownames(matrix) <- c("sampling unit", species)
  
  df <- as.data.frame(matrix) 
  
  tsf_list <- append(tsf_list, list(df))
  names(tsf_list)[length(tsf_list)] <- y
   }
  recoverytsf_list <- append(recoverytsf_list, list(tsf_list))
  
  names(recoverytsf_list)[d] <- desert[d]
}


#capture.output(recoverytsf_list, file = "recovery_tsf_list.csv")
```
### Chao Two Community Similarity
```{r SpadeR SimPair, include = FALSE}
#Chao Similarity Pair

desert1 <- c()
yearsSinceFire <- c()
SpRich_burned <- c()
SpRich_control <- c()
SI <- c()
SI_CIlower <- c()
SI_CIupper <- c()
error_desert <- c()
error_tsf <- c()

for (d in 1:3) {
  
  for (t in 1:length(recoverytsf_list[[d]])){
    tryCatch(
      #try to do this
      {
    
      Sim <- SimilarityPair(recoverytsf_list[[d]][[t]],"incidence_freq", nboot = 200)
      
      desert1 <- append(desert1, names(recoverytsf_list[d]))
      yearsSinceFire <- append(yearsSinceFire, as.integer(names(recoverytsf_list[[d]][t])))
      SpRich_burned <- append(SpRich_burned, Sim[["info"]][["D1"]])
      SpRich_control <- append(SpRich_control, Sim[["info"]][["D2"]])
      SI <- append(SI, Sim[["estimated_relative"]][[5]])
      SI_CIlower <- append(SI_CIlower, Sim[["estimated_relative"]][[5, 3]])
      SI_CIupper <- append(SI_CIupper, Sim[["estimated_relative"]][[5, 4]])
      
      
      },
      #if an error occurs, say error
      
      error=function(e) {
        message(paste('An Error Occurred for:', desert[d], '| TSF:', as.integer(names(recoverytsf_list[[d]][t]))))
        # print(e)
        # error_desert <- append(error_desert, desert[d])
        # error_tsf <- append(error_tsf, as.integer(names(recoverytsf_list[[d]][tsf])))
        }
      
    )
  }
    
  }
df_tsf <- data.frame(desert1, yearsSinceFire, SpRich_burned, SpRich_control, SI, SI_CIlower, SI_CIupper) %>%
  rename(desert = desert1)
# 
# df_error <- data.frame(error_desert, error_tsf)

#45 errors

```
```{r SpadeR SimPair graph}

ggplot(df_tsf, aes(x=yearsSinceFire, y=SI, color = desert)) +
  geom_point() +
  geom_errorbar(aes(ymin=SI_CIlower, ymax=SI_CIupper), color = "black", width=.2) +
  geom_smooth(method = "lm", se = FALSE)

print(df_tsf)
```


### Chao Community Species and Shared Species
```{r SpadeR ChaoShared, include = FALSE}
#Chao Similarity Pair

CShared <- ChaoShared(recoverytsf_list[[1]][[1]], datatype = "incidence_freq")

CSpecies <- ChaoSpecies(as.data.frame(recoverytsf_list[[1]][[2]][["control"]]), datatype="incidence_freq",k=5,conf=0.95)


##ChaoSpecies
desert1 <- c()
yearsSinceFire <- c()
tG <- c()
Chao2 <- c()
Chao2_CIlower <- c()
Chao2_CIupper <- c()


for (d in 1:3) {
  for (g in 1:2){
    for (t in 1:length(recoverytsf_list[[d]])){
      
      tryCatch(
      #try to do this
      {
        CSpecies <- ChaoSpecies(as.data.frame(recoverytsf_list[[d]][[t]][[g]]), datatype="incidence_freq",k=3,conf=0.95)
      
        desert1 <- append(desert1, names(recoverytsf_list[d]))
        yearsSinceFire <- append(yearsSinceFire, as.integer(names(recoverytsf_list[[d]][t])))
        tG <- append(tG, names(recoverytsf_list[[d]][[t]][g]))
        Chao2 <- append(Chao2, CSpecies[["Species_table"]][[2, 1]])
        Chao2_CIlower <- append(Chao2_CIlower, CSpecies[["Species_table"]][[2, 3]])
        Chao2_CIupper <- append(Chao2_CIupper, CSpecies[["Species_table"]][[2, 4]])
        
        },
      error=function(e) {
        message(paste('An Error Occurred for:', 
                      desert[d], 
                      names(recoverytsf_list[[d]][[t]][g]) , 
                      '| TSF:', as.integer(names(recoverytsf_list[[d]][t])), 
                      '| Zeros: ', sum(recoverytsf_list[[d]][[t]][[g]]==0)))
        # print(e)
        # error_desert <- append(error_desert, desert[d])
        # error_tsf <- append(error_tsf, as.integer(names(recoverytsf_list[[d]][tsf])))
      }
      )
      
    }
  }
  
}
df_species <- data.frame(desert1, yearsSinceFire, tG, Chao2, Chao2_CIlower, Chao2_CIupper) %>%
  rename(desert = desert1, treatmentGroup = tG)


##ChaoShared
      
      
desert1 <- c()
yearsSinceFire <- c()
spRep_burned <- c()
spRep_control <- c()
CShared <-  c()
CShared_CIlower <- c()
CShared_CIupper <- c()


##ChaoShared
for (d in 1:3) {
  
  for (t in 1:length(recoverytsf_list[[d]])){
    tryCatch(
      #try to do this
      {
    
      ChaoShared <- ChaoShared(recoverytsf_list[[d]][[t]],"incidence_freq", nboot = 200)
      desert1 <- append(desert1, names(recoverytsf_list[d]))
      yearsSinceFire <- append(yearsSinceFire, as.integer(names(recoverytsf_list[[d]][t])))
      spRep_burned <- append(spRep_burned, ChaoShared[["Basic_data_information"]][["D1"]])
      spRep_control <- append(spRep_control, ChaoShared[["Basic_data_information"]][["D2"]]) 
      CShared <- append(CShared, ChaoShared[["Estimation_results"]][[1]])
      CShared_CIlower <- append(CShared_CIlower, ChaoShared[["Estimation_results"]][[1, 3]])
      CShared_CIupper <- append(CShared_CIupper, ChaoShared[["Estimation_results"]][[1, 4]])
      
      
      },
      #if an error occurs, say error
      
      error=function(e) {
        message(paste('An Error Occurred for:', desert[d], '| TSF:', as.integer(names(recoverytsf_list[[d]][t]))))
        # print(e)
        # error_desert <- append(error_desert, desert[d])
        # error_tsf <- append(error_tsf, as.integer(names(recoverytsf_list[[d]][tsf])))
        }
      
    )
  }
    
}
df_shared <- data.frame(desert1, yearsSinceFire,  spRep_burned, spRep_control, CShared, CShared_CIlower, CShared_CIupper) %>%
  rename(desert = desert1)


# 

```

```{r SpadeR ChaoShared ChaoSpecies graph}
ggplot(df_shared, aes(x=yearsSinceFire, y=CShared, color = desert)) +
  geom_point() +
  #geom_errorbar(aes(ymin=CShared_CIlower, ymax=CShared_CIupper), color = "black", width=.2) +
  geom_smooth(method = "lm", se = FALSE)

ggplot(df_species, aes(x=yearsSinceFire, y=Chao2, color = desert, shape = treatmentGroup)) +
  geom_point() +
  geom_errorbar(aes(ymin=Chao2_CIlower, ymax=Chao2_CIupper), color = "black", width=.2) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(vars(treatmentGroup))

```

