---
title: "Analysis_ALL"
author: "Marina"
date: "11/16/2021"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
---
##### load packages and data
code not included
```{r packages and data, message=FALSE, include=FALSE}
library(tidyverse)
library(mgcv)
library(sf)
library(lwgeom)
library(lme4)
library(ggsci)
library(ggrepel)
library(stats)
library(broom)

setwd("~/GitHub/desert-fires-impact-biodiversity")

animals <- st_read("shapefiles/animals/animals_51022.shp") %>% 
  st_drop_geometry() %>% 
  rename(obsID = TARGET_FID, order = order_, individualCount = individual, obsDay = day, obsMonth = month, obsYear = year, institutionalCode = institutio, treatmentGroup = treatmentG, fireName = INCIDENT, fireYear = FIRE_YEARn, fireSize = GISAcres) %>% 
  select(-c("verbatimSc", "issue", "coordinate", 'nearRd_FID', "nearUA_FID")) %>% 
  filter(obsYear > 1999, obsYear < 2021, species != "Canis lupus", species != "Balaenoptera musculus", species != "Grus canadensis")
  

ndvi_burned <- read_csv("data/mean_ndvi_burned.csv") %>% 
  mutate(treatmentGroup = "burned")
ndvi_nb <- read_csv("data/mean_ndvi_never_burned.csv") %>% 
  mutate(treatmentGroup = "never burned")

ndvi <- rbind(ndvi_burned, ndvi_nb) %>% 
  rename(obsYear = year)

data <- animals %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n()) %>% 
  filter(treatmentGroup != "burned prior 2000")


sites <- read_csv("data/sitesv2-2022.csv") %>% 
  select(-desert)

sites_sf <- st_read("shapefiles/fires/fires2000.shp")

fireid <- unique(sites$fireID)

sites_sf <- sites_sf %>% filter(fireID %in% fireid)

sites_sf$confirmarea <- st_geod_area(sites_sf)

#view(sites_sf) #areas for area_km2 confirmed

#just the fires for occurrences
fireid <- unique(animals$fireID)[-1]

sites$fireID <- as.factor(sites$fireID)
sites_sf$fireID <- as.factor(sites_sf$fireID)


sites_sf <- as.data.frame(sites_sf) %>% filter(fireID %in% fireid) %>%
  left_join(sites, by = "fireID") %>% 
  select(c(desert, INCIDENT, FIRE_YEARn, fireID, area_km2, startDate))


```

```{r get areas, include=FALSE}
fireid <- unique(animals$fireID)

fire_area <- st_read("shapefiles/fires/fires2000.shp") %>% #polygons for never-burned desert sites
        st_transform(crs = 4326) %>% #transform data to wgs84 to match raster
        filter(fireID %in% fireid)

fire_area_sj <- fire_area %>% 
  filter(desert == "San Joaquin")
fire_area_moj <- fire_area %>% 
  filter(desert == "Mojave")
fire_area_son <- fire_area %>% 
  filter(desert == "Sonoran")


desert <- c("San Joaquin", "Mojave", "Sonoran")
area_km2 <- c(as.numeric(sum(fire_area_sj$area_km2)),
              as.numeric(sum(fire_area_moj$area_km2)),
              as.numeric(sum(fire_area_son$area_km2)))

areas <- data.frame(desert, area_km2) %>% 
  mutate(treatmentGroup = "burned")

head(areas)

nb_area <- st_read("shapefiles/deserts/minus-fires/deserts-minus-fires.shp") %>% #polygons for never-burned desert sites
        st_transform(crs = 4326) #transform data to wgs84 to match raster

nb_area_sj <- nb_area %>% 
  filter(desert == "San Joaquin")
nb_area_moj <- nb_area %>% 
  filter(desert == "Mojave")
nb_area_son <- nb_area %>% 
  filter(desert == "Sonoran")

nb_area_moj$area_km2 <- st_geod_area(nb_area_moj) / 1000000
as.numeric(sum(nb_area_moj$area_km2))
nb_area_sj$area_km2 <- st_geod_area(nb_area_sj) / 1000000
as.numeric(sum(nb_area_sj$area_km2))
nb_area_son$area_km2 <- st_geod_area(nb_area_son) / 1000000
as.numeric(sum(nb_area_son$area_km2))

area_km2 <- c(as.numeric(sum(nb_area_sj$area_km2)),
              as.numeric(sum(nb_area_moj$area_km2)),
              as.numeric(sum(nb_area_son$area_km2)))
areas_nb <- data.frame(desert, area_km2) %>% 
  mutate(treatmentGroup = "never burned")
areas <- rbind(areas, areas_nb)

head(areas)

```

```{r NDVI to data, warnings=FALSE, include=FALSE}
data <- animals %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n()) %>% 
  filter(treatmentGroup != "burned prior 2000")

#add ndvi data
data <- left_join(data, ndvi, by = c("desert", "obsYear", "treatmentGroup"))

#add area for burned and unburned
data <- left_join(data, areas, by = c("desert", "treatmentGroup")) %>% #areas is a dataframe created from shapefiles in a hidden step
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2) #total observation per 10000 km2

data$desert <- as.factor(data$desert)
data$treatmentGroup <- as.factor(data$treatmentGroup)
```

## mean annual NDVI

```{r average ndvi }
#mean annual NDVI
ggplot(ndvi, aes(x = obsYear, y = ndvi, color = treatmentGroup, shape = desert)) +
  geom_point(size = 3) +
  ylim(0, 0.5) +
  xlim(2000, 2020) +
  facet_grid(vars(desert)) +
  ylab("Mean NDVI") +
  xlab("") + 
  labs(color = "Treatment Group") +
  scale_color_uchicago(labels=c("Burned area", "Control")) +
  scale_shape_discrete(guide = 'none') +
  theme_bw()


#boxplot showing mean annual NDVI  
ggplot(ndvi, aes(x = treatmentGroup, y = ndvi, color = desert)) +
  geom_boxplot(outlier.shape = 18)  +
  ylab("Annual Mean NDVI") +
  xlab("") +
  scale_color_aaas() +
  theme_classic() + 
  theme(axis.text.y = element_text(size = 12), 
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12)) +
  scale_x_discrete(labels=c("Burned area", "Control"))

# number of fires and total burned area 
sites_sf %>% group_by(desert, FIRE_YEARn) %>% 
  summarize(total_fires = n(), total_area_burned = sum(area_km2)) %>% 
  ggplot(aes(x = FIRE_YEARn, y = total_fires, color = desert)) +
  geom_segment(aes(x = FIRE_YEARn, xend = FIRE_YEARn, y = 0, yend = total_fires), color = "black") +
  geom_point(aes(size = total_area_burned)) +
  theme_classic() +
  facet_grid(rows = vars(desert)) +
  scale_size_continuous(breaks = c(5, 25, 250), name = bquote("Total burned area "(km^2))) +
  scale_x_continuous(breaks = c(2000:2020)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  xlab("Year") +
  ylab("Total number of fires") +
  scale_color_aaas(guide = 'none')


```


## ALL classes

### distinct classes reported

```{r tables and graphs all class - class composition of data, message=FALSE, include= FALSE}

## which class make up the occurrences
species_dist <- animals %>% group_by(class) %>% 
  filter(treatmentGroup != "burned prior 2000") %>% 
  summarize(total_rec = n()) %>% 
  arrange(desc(-total_rec)) %>% 
  mutate(percent = (total_rec/sum(total_rec)),label = (paste0(class, "\n", total_rec)))

unique(species_dist$class)

species_dist %>%
  arrange(desc(-total_rec)) %>%
  mutate(class=factor(class, class)) %>%
  ggplot( aes(x=class, y=total_rec) ) +
    geom_segment(aes(x=class ,xend=class, y=0, yend=total_rec), color="grey", size = 2) +
    geom_point(size=5, color=c("#242c47", "#242c47", "#242c47", "#242c47", "#242c47", "#242c47", "#242c47")) +
    coord_flip() +
    geom_text(aes(label = total_rec), nudge_x = 0.35) +
    theme_classic() +
    theme(panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          legend.position="none",
          axis.text = element_text(size = 12)) +
    xlab("") +
    ylab("Occurrences")

```


### Standardized to # of occurrences reported per **1,000km^2** 

```{r table}
#table showing summarized values (standardized to obs per 1,000km2)
data %>% group_by(treatmentGroup, desert) %>% summarize(totalObs = sum(totalObs), mean_ndvi = mean(ndvi), area_km2 = mean(area_km2), total_standard_obs = sum(stzd_totalObs))
```


### total occurrences reported over the 20-year period

```{r viz on occurrences over the years1}

data %>% group_by(treatmentGroup, desert) %>% summarize(totalObs = sum(totalObs), mean_ndvi = mean(ndvi), area_km2 = mean(area_km2), total_standard_obs = sum(stzd_totalObs)) %>% 
  ggplot(aes(x = treatmentGroup, y = total_standard_obs, fill = desert)) +
  geom_col(width = 0.7, position = position_dodge(0.75)) +
  ylab(bquote('Total occurrences reported per 1,000 km'^2)) +
  xlab("")+
  scale_fill_aaas() +
  scale_x_discrete(labels=c("Burned area", "Control")) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 12), 
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank())
```

### annual change in occurrence reporting

```{r}

ggplot(data, aes(x = obsYear, y = stzd_totalObs, color = treatmentGroup)) +
  geom_point(size = 2) +
  geom_smooth(method = "gam", aes(fill = treatmentGroup)) +
  ylim(0, 70) +
  xlim(2000, 2020) +
  facet_grid(vars(desert)) +
  ylab(bquote('Total occurrences reported per 1,000 km'^2)) +
  xlab("Year") +
  scale_color_uchicago(name = "Burn Treatment",
                     labels = c("Burned", "Control")) +
  scale_fill_manual(values = c("#800000ff", "#767676FF"),
                    name = "Burn Treatment",
                    labels = c("Burned", "Control")) +
  theme_bw()

```


## NO birds

```{r reload data2, include = FALSE}
data <- animals  %>% 
  filter(treatmentGroup != "burned prior 2000", class != 'Aves') %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n())

#add ndvi data
data <- left_join(data, ndvi, by = c("desert", "obsYear", "treatmentGroup"))

#add area for burned and unburned
data <- left_join(data, areas, by = c("desert", "treatmentGroup")) %>% #areas is a dataframe created from shapefiles in a hidden step
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2) #total observation per 10000 km2

data$desert <- as.factor(data$desert)
data$treatmentGroup <- as.factor(data$treatmentGroup)
```

### distinct classes reported

```{r tables and graphs no birds - class composition of data, message=FALSE}

## which class make up the occurrences
species_dist <- animals %>% 
  filter(treatmentGroup != "burned prior 2000", class != 'Aves') %>% 
  group_by(class) %>% 
  summarize(total_rec = n()) %>% 
  arrange(desc(-total_rec)) %>% 
  mutate(percent = (total_rec/sum(total_rec)),label = (paste0(class, "\n", total_rec)))

unique(species_dist$class)

species_dist %>%
  arrange(desc(-total_rec)) %>%
  mutate(class=factor(class, class)) %>%
  ggplot( aes(x=class, y=total_rec) ) +
    geom_segment(aes(x=class ,xend=class, y=0, yend=total_rec), color="grey", size = 2) +
    geom_point(size=5, color= "#242c47") +
    coord_flip() +
    geom_text(aes(label = total_rec), nudge_x = 0.35) +
    theme_classic() +
    theme(panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          legend.position="none",
          axis.text = element_text(size = 12)) +
    xlab("") +
    ylab("Occurrences")

```

### Standardized to # of occurrences reported per **1,000km^2** 

```{r table2}
#table showing summarized values (standardized to obs per 1,000km2)

data %>% group_by(treatmentGroup, desert) %>% summarize(totalObs = sum(totalObs), mean_ndvi = mean(ndvi), area_km2 = mean(area_km2), total_standard_obs = sum(stzd_totalObs))
```


### total occurrences reported over the 20-year period

```{r viz on occurrences over the years2}

data %>% group_by(treatmentGroup, desert) %>% summarize(totalObs = sum(totalObs), mean_ndvi = mean(ndvi), area_km2 = mean(area_km2), total_standard_obs = sum(stzd_totalObs)) %>% 
  ggplot(aes(x = treatmentGroup, y = total_standard_obs, fill = desert)) +
  geom_col(width = 0.7, position = position_dodge(0.75)) +
  ylab(bquote('Total occurrences reported per 1,000 km'^2)) +
  xlab("")+
  annotate("text", x = 2, y = 225, label = "*Birds filtered out from data") +
  scale_fill_aaas() +
  scale_x_discrete(labels=c("Burned area", "Control")) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 12), 
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank())
```

### annual change in occurrence reporting

```{r}

ggplot(data, aes(x = obsYear, y = stzd_totalObs, color = treatmentGroup)) +
  geom_point(size = 2) +
  geom_smooth(method = "gam", aes(fill = treatmentGroup)) +
  ylim(0, 70) +
  xlim(2000, 2020) +
  facet_grid(vars(desert)) +
  ylab(bquote('Total occurrences reported per 1,000 km'^2)) +
  xlab("Year") +
  scale_color_uchicago(name = "Burn Treatment",
                     labels = c("Burned", "Control")) +
  scale_fill_manual(values = c("#800000ff", "#767676FF"),
                    name = "Burn Treatment",
                    labels = c("Burned", "Control")) +
  theme_bw()

```


## ONLY birds

```{r reload data3, include = FALSE}
data <- animals  %>% 
  filter(treatmentGroup != "burned prior 2000", class == 'Aves') %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n())

#add ndvi data
data <- left_join(data, ndvi, by = c("desert", "obsYear", "treatmentGroup"))

#add area for burned and unburned
data <- left_join(data, areas, by = c("desert", "treatmentGroup")) %>% #areas is a dataframe created from shapefiles in a hidden step
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2) #total observation per 10000 km2

data$desert <- as.factor(data$desert)
data$treatmentGroup <- as.factor(data$treatmentGroup)
```

### class occurrences reported

```{r tables and graphs only birds - class composition of data, message=FALSE}

## which class make up the occurrences
species_dist <- animals %>% 
  filter(treatmentGroup != "burned prior 2000", class == 'Aves') %>% 
  group_by(species) %>% 
  summarize(total_rec = n()) %>% 
  arrange(desc(-total_rec)) %>% 
  mutate(percent = (total_rec/sum(total_rec)),label = (paste0(species, "\n", total_rec)))

unique(species_dist$species)

species_dist %>%
  arrange(desc(-total_rec)) %>%
  mutate(species=factor(species, species)) %>%
  ggplot(aes(x=species, y=total_rec) ) +
    geom_segment(aes(x=species ,xend=species, y=0, yend=total_rec), color="grey", size = 2) +
    geom_point(size=5, color= "#242c47") +
    coord_flip() +
    geom_text(aes(label = total_rec), nudge_x = 0.35) +
    theme_classic() +
    theme(panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          legend.position="none",
          axis.text = element_text(size = 12)) +
    xlab("") +
    ylab("Occurrences")

```


### Standardized to # of occurrences reported per 1,000km^2 

```{r table3}
#table showing summarized values (standardized to obs per 1,000km2)

data %>% group_by(treatmentGroup, desert) %>% summarize(totalObs = sum(totalObs), mean_ndvi = mean(ndvi), area_km2 = mean(area_km2), total_standard_obs = sum(stzd_totalObs))
```


### total occurrences reported over the 20-year period

```{r viz on occurrences over the years3}

data %>% group_by(treatmentGroup, desert) %>% summarize(totalObs = sum(totalObs), mean_ndvi = mean(ndvi), area_km2 = mean(area_km2), total_standard_obs = sum(stzd_totalObs)) %>% 
  ggplot(aes(x = treatmentGroup, y = total_standard_obs, fill = desert)) +
  geom_col(width = 0.7, position = position_dodge(0.75)) +
  ylab(bquote('Total bird occurrences reported per 1,000 km'^2)) +
  xlab("")+
  scale_fill_aaas() +
  scale_x_discrete(labels=c("Burned area", "Control")) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 12), 
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank())
```

### annual change in occurrence reporting

```{r}

ggplot(data, aes(x = obsYear, y = stzd_totalObs, color = treatmentGroup)) +
  geom_point(size = 2) +
  geom_smooth(method = "gam", aes(fill = treatmentGroup)) +
  ylim(0, 70) +
  xlim(2000, 2020) +
  facet_grid(vars(desert)) +
  ylab(bquote('Total occurrences reported per 1,000 km'^2)) +
  xlab("Year") +
  scale_color_uchicago(name = "Burn Treatment",
                     labels = c("Burned", "Control")) +
  scale_fill_manual(values = c("#800000ff", "#767676FF"),
                    name = "Burn Treatment",
                    labels = c("Burned", "Control")) +
  theme_bw()

```


## stats

### linear models and GAMS

#### All
```{r reload data1.1, include = FALSE}
data <- animals  %>% 
  filter(treatmentGroup != "burned prior 2000") %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n())

#add ndvi data
data <- left_join(data, ndvi, by = c("desert", "obsYear", "treatmentGroup"))

#add area for burned and unburned
data <- left_join(data, areas, by = c("desert", "treatmentGroup")) %>% #areas is a dataframe created from shapefiles in a hidden step
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2) #total observation per 10000 km2

data$desert <- as.factor(data$desert)
data$treatmentGroup <- as.factor(data$treatmentGroup)
```

```{r, include=FALSE}
model_lm1 <- lm(stzd_totalObs ~ obsYear + ndvi + desert + treatmentGroup, data = data)
summary(model_lm1)

model_lm2 <- lm(stzd_totalObs ~ obsYear + ndvi + treatmentGroup, data = data)
summary(model_lm2)

model_lm3 <- lm(stzd_totalObs ~ obsYear + desert + ndvi, data = data)
summary(model_lm3)

AIC(model_lm1, model_lm2, model_lm3)

model_gam0 <- gam(stzd_totalObs ~ s(obsYear) + ndvi + desert + treatmentGroup, data = data, method = "REML")
summary(model_gam0)

model_gam1 <- gam(stzd_totalObs ~ s(obsYear, by = desert) + s(ndvi, by = desert) + desert + treatmentGroup, data = data, method = "REML")
summary(model_gam1)

model_gam2 <- gam(stzd_totalObs ~ s(obsYear, by = treatmentGroup) + ndvi + desert + treatmentGroup,family = tw(link = "log"), data = data, method = "REML")
summary(model_gam2)

model_gam3 <- gam(stzd_totalObs ~ s(obsYear, by = desert) + s(ndvi) + desert + treatmentGroup, family = tw(link = "log"), data = data, method = "REML")
summary(model_gam3)

gam.check(model_gam0)
gam.check(model_gam1)
gam.check(model_gam2)
gam.check(model_gam3)


AIC(model_gam0, model_gam1, model_gam2, model_gam3, model_lm1)
```


```{r broom1}
AIC(model_lm1, model_lm2, model_lm3)

tidy(model_lm3)
augment(model_lm3)
glance(model_lm3)

AIC(model_gam0, model_gam1, model_gam2, model_gam3, model_lm3)

#model_gam3 has a lower AIC value and is, therefore, a better-fit model.


#model_gam3 <- gam(stzd_totalObs ~ s(obsYear, by = desert) + s(ndvi) + desert + treatmentGroup, family = tw(link = "log"), data = data, method = "REML")

tidy(model_gam3)
augment(model_gam3)
glance(model_gam3)

gam.check(model_gam3)


```


##### plot GAMs

```{r}
plot(model_gam3, all.terms = TRUE)

```


#### No birds
```{r reload data2.1, include = FALSE}
data <- animals  %>% 
  filter(treatmentGroup != "burned prior 2000", class != 'Aves') %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n())

#add ndvi data
data <- left_join(data, ndvi, by = c("desert", "obsYear", "treatmentGroup"))

#add area for burned and unburned
data <- left_join(data, areas, by = c("desert", "treatmentGroup")) %>% #areas is a dataframe created from shapefiles in a hidden step
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2) #total observation per 10000 km2

data$desert <- as.factor(data$desert)
data$treatmentGroup <- as.factor(data$treatmentGroup)
```

```{r, include=FALSE}
model_lm1 <- lm(stzd_totalObs ~ obsYear + ndvi + desert + treatmentGroup, data = data)
summary(model_lm1)

model_lm2 <- lm(stzd_totalObs ~ obsYear + ndvi + treatmentGroup, data = data)
summary(model_lm2)

model_lm3 <- lm(stzd_totalObs ~ obsYear + desert + ndvi, data = data)
summary(model_lm3)

AIC(model_lm1, model_lm2, model_lm3)

model_gam0 <- gam(stzd_totalObs ~ s(obsYear) + ndvi + desert + treatmentGroup, data = data, method = "REML")
summary(model_gam0)

model_gam1 <- gam(stzd_totalObs ~ s(obsYear, by = desert) + s(ndvi, by = desert) + desert + treatmentGroup, data = data, method = "REML")
summary(model_gam1)

model_gam2 <- gam(stzd_totalObs ~ s(obsYear, by = treatmentGroup) + ndvi + desert + treatmentGroup,family = tw(link = "log"), data = data, method = "REML")
summary(model_gam2)

model_gam3 <- gam(stzd_totalObs ~ s(obsYear, by = desert) + s(ndvi) + desert + treatmentGroup, family = tw(link = "log"), data = data, method = "REML")
summary(model_gam3)

gam.check(model_gam0)
gam.check(model_gam1)
gam.check(model_gam2)
gam.check(model_gam3)


AIC(model_gam0, model_gam1, model_gam2, model_gam3, model_lm1)
```


```{r broom2}
AIC(model_lm1, model_lm2, model_lm3)

tidy(model_lm1)
augment(model_lm1)
glance(model_lm1)

AIC(model_gam0, model_gam1, model_gam2, model_gam3, model_lm1)

#model_gam2 has a lower AIC value and is, therefore, a better-fit model.


#model_gam2 <- gam(stzd_totalObs ~ s(obsYear, by = treatmentGroup) + ndvi + desert + treatmentGroup,family = tw(link = "log"), data = data, method = "REML")

tidy(model_gam2)
augment(model_gam2)
glance(model_gam2)



```

##### plot GAMs

```{r}
plot(model_gam2, all.terms = TRUE)

```


#### ONLY birds
```{r reload data3.1, include = FALSE}
data <- animals  %>% 
  filter(treatmentGroup != "burned prior 2000", class == 'Aves') %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n())

#add ndvi data
data <- left_join(data, ndvi, by = c("desert", "obsYear", "treatmentGroup"))

#add area for burned and unburned
data <- left_join(data, areas, by = c("desert", "treatmentGroup")) %>% #areas is a dataframe created from shapefiles in a hidden step
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2) #total observation per 10000 km2

data$desert <- as.factor(data$desert)
data$treatmentGroup <- as.factor(data$treatmentGroup)
```

```{r, include = FALSE}
model_lm1 <- lm(stzd_totalObs ~ obsYear + ndvi + desert + treatmentGroup, data = data)
summary(model_lm1)

model_lm2 <- lm(stzd_totalObs ~ obsYear + ndvi + treatmentGroup, data = data)
summary(model_lm2)

model_lm3 <- lm(stzd_totalObs ~ obsYear + desert + ndvi, data = data)
summary(model_lm3)

AIC(model_lm1, model_lm2, model_lm3)

model_gam0 <- gam(stzd_totalObs ~ s(obsYear) + ndvi + desert + treatmentGroup, data = data, method = "REML")
summary(model_gam0)

model_gam1 <- gam(stzd_totalObs ~ s(obsYear, by = desert) + s(ndvi, by = desert) + desert + treatmentGroup, data = data, method = "REML")
summary(model_gam1)

model_gam2 <- gam(stzd_totalObs ~ s(obsYear, by = treatmentGroup) + ndvi + desert + treatmentGroup,family = tw(link = "log"), data = data, method = "REML")
summary(model_gam2)

model_gam3 <- gam(stzd_totalObs ~ s(obsYear, by = desert) + s(ndvi) + desert + treatmentGroup, family = tw(link = "log"), data = data, method = "REML")
summary(model_gam3)

gam.check(model_gam0)
gam.check(model_gam1)
gam.check(model_gam2)
gam.check(model_gam3)


AIC(model_gam0, model_gam1, model_gam2, model_gam3, model_lm1)
```

```{r broom3}
AIC(model_lm1, model_lm2, model_lm3)

tidy(model_lm2)
augment(model_lm2)
glance(model_lm2)

AIC(model_gam0, model_gam1, model_gam2, model_gam3, model_lm2)

#model_gam3 has a lower AIC value and is, therefore, a better-fit model.


#model_gam3 <- gam(stzd_totalObs ~ s(obsYear, by = desert) + s(ndvi) + desert + treatmentGroup, family = tw(link = "log"), data = data, method = "REML")

tidy(model_gam3)
augment(model_gam3)
glance(model_gam3)



```


##### plot GAMs

```{r}
plot(model_gam3, all.terms = TRUE)

```


### ANOVA

#### All
```{r reload data1.2, include = FALSE}
data <- animals  %>% 
  filter(treatmentGroup != "burned prior 2000") %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n())

#add ndvi data
data <- left_join(data, ndvi, by = c("desert", "obsYear", "treatmentGroup"))

#add area for burned and unburned
data <- left_join(data, areas, by = c("desert", "treatmentGroup")) %>% #areas is a dataframe created from shapefiles in a hidden step
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2) #total observation per 10000 km2

data$desert <- as.factor(data$desert)
data$treatmentGroup <- as.factor(data$treatmentGroup)
```

```{r}
head(data)

occ_anova1 <- aov(stzd_totalObs ~ treatmentGroup, data = data)
occ_anova2 <- aov(stzd_totalObs ~ desert + treatmentGroup, data = data)
occ_anova3 <- aov(stzd_totalObs ~ desert*treatmentGroup, data = data)

AIC(occ_anova1, occ_anova2, occ_anova3)

summary(occ_anova3)

TukeyHSD(occ_anova3)

plot(occ_anova3)

```

Results: 
- significant difference between occurrences reported in San Joaquin and Mojave.
- no sig. diff. between burned and control (neither overall or between deserts)

#### No birds
```{r reload data2.2, include = FALSE}
data <- animals  %>% 
  filter(treatmentGroup != "burned prior 2000", class != "Aves") %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n())

#add ndvi data
data <- left_join(data, ndvi, by = c("desert", "obsYear", "treatmentGroup"))

#add area for burned and unburned
data <- left_join(data, areas, by = c("desert", "treatmentGroup")) %>% #areas is a dataframe created from shapefiles in a hidden step
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2) #total observation per 10000 km2

data$desert <- as.factor(data$desert)
data$treatmentGroup <- as.factor(data$treatmentGroup)
```

```{r}
head(data)

occ_anova1 <- aov(stzd_totalObs ~ treatmentGroup, data = data)
occ_anova2 <- aov(stzd_totalObs ~ desert + treatmentGroup, data = data)
occ_anova3 <- aov(stzd_totalObs ~ desert*treatmentGroup, data = data)

AIC(occ_anova1, occ_anova2, occ_anova3)

summary(occ_anova3)

TukeyHSD(occ_anova3)

plot(occ_anova3)

```

Results: 
- significant difference between occurrences reported in Sonoran and Mojave(even though their NDVI were not significantly different).
- significant difference between burned and control (when not taking desert into account)
- sig. diff. between Sonoran burned and control
- no sig. diff. between Moj or San Joaquin burned and control


#### Only birds
```{r reload data3.2, include = FALSE}
data <- animals  %>% 
  filter(treatmentGroup != "burned prior 2000", class == 'Aves') %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n())

#add ndvi data
data <- left_join(data, ndvi, by = c("desert", "obsYear", "treatmentGroup"))

#add area for burned and unburned
data <- left_join(data, areas, by = c("desert", "treatmentGroup")) %>% #areas is a dataframe created from shapefiles in a hidden step
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2) #total observation per 10000 km2

data$desert <- as.factor(data$desert)
data$treatmentGroup <- as.factor(data$treatmentGroup)
```

```{r}
head(data)

occ_anova1 <- aov(stzd_totalObs ~ treatmentGroup, data = data)
occ_anova2 <- aov(stzd_totalObs ~ desert + treatmentGroup, data = data)
occ_anova3 <- aov(stzd_totalObs ~ desert*treatmentGroup, data = data)

AIC(occ_anova1, occ_anova2, occ_anova3)

summary(occ_anova3)

TukeyHSD(occ_anova3)

plot(occ_anova3)

```
