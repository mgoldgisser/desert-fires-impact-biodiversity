---
title: "index_recovery"
author: "Marina"
date: '2022-12-18'
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
---

##### load packages and data
{code not included}
```{r packages and data, message=FALSE, include=FALSE}
library(tidyverse)
library(mgcv)
library(sf)
#library(lwgeom)
library(lme4)
library(ggsci)
#library(ggrepel)
library(stats)
#library(broom)
#library(gghighlight)
library(gamm4)
#library(MuMIn)
library(cowplot)
library(MASS) #for glm.nb
library(pscl) #for zero-inflated glm
library(lmtest) #for lrtest: likelihood test of nested models
library(VGAM) #for zero-truncated models
library(countreg) #for zero-truncated models
library(glmmTMB) #glmm with zero-truncated nb
library(DHARMa) #diagnostic for mixed regression models
library(emmeans)
library(remote)

setwd("~/GitHub/desert-fires-impact-biodiversity")

sm_mam <- c("Ammospermophilus", "Xerospermophilus", "Dipodomys", "Vulpes")
raptors  <- c("Accipitriformes", 'Pelecaniformes', "Strigiformes", "Falconiformes")

animals <- st_read("shapefiles/animals/animals_51022.shp") %>% 
  st_drop_geometry() %>% 
  rename(obsID = TARGET_FID, order = order_, 
         individualCount = individual, obsDay = day, 
         obsMonth = month, obsYear = year, 
         institutionalCode = institutio, 
         treatmentGroup = treatmentG, fireName = INCIDENT, 
         fireYear = FIRE_YEARn, fireSize = GISAcres) %>% 
  dplyr::select(-c("verbatimSc", "issue", "coordinate", 'nearRd_FID', "nearUA_FID", 
            'basisOfRec', 'institutionalCode', 'collection', 'recordedBy', 'nearRdDist', 'nearUADist')) %>% 
  filter(obsYear > 1994, obsYear < 2021, species != "Canis lupus", species != "Balaenoptera musculus", 
         species != "Grus canadensis", treatmentGroup != "burned prior 2000") %>%  
  mutate(funcGroup =
                     ifelse(genus == "Puma" | genus == "Ovis", "Large Mammals",
                            ifelse(genus == "Branchinecta" | genus == "Cyprinodon", "Aquatic",
                            ifelse(genus == "Dinacoma", "Beetles",
                            ifelse(genus == "Bombus", "Bees",
                            ifelse(genus == "Gopherus", "Tortoises",
                            ifelse(genus == "Danaus" | genus == "Euproserpinus", "Butterflies & Moths",
                            ifelse(genus == "Rana" | genus == "Anaxyrus","Frogs and Toads",
                            ifelse(genus == "Ambystoma" | genus == "Batrachoseps", "Salamanders",
                            ifelse(genus == "Coleonyx" | genus == "Gambelia" | genus == "Uma", "Lizards and Geckos",
                            ifelse(genus %in% sm_mam, "Small Mammals",
                            ifelse(order %in% raptors, "Birds:Raptors",
                            ifelse(order == "Passeriformes", "Birds:Passerines",
                            ifelse(order == "Piciformes", "Birds:Woodpeckers",
                            ifelse(order == "Gruiformes" | order == "Anseriformes", "Birds:Rails and Geese", "ERROR"
                                   )))))))))))))),
         ez_taxa = ifelse(class=='Aves', 'Aves', 'Other'),
         individualCount = ifelse(individualCount == 0, 1, individualCount))


ndvi <- read_csv("data/ndvi.csv")
areas <- read.csv('data/areas.csv')
sites <- read_csv("data/sites.csv")


data2a <- animals %>%
  group_by(obsYear, funcGroup, ez_taxa, treatmentGroup, desert) %>% 
  summarize(totalObs = sum(individualCount))

data <- data.frame(obsYear = rep(1995:2020, each = 84),
                    desert = rep(rep(c("Mojave", "San Joaquin", "Sonoran"), each = 2), times = 364),
                    treatmentGroup = rep(rep(c("burned", "never burned"), times = 42), times = 26),
                    funcGroup = rep(rep(c("Large Mammals", "Aquatic","Beetles", "Bees", "Tortoises",
                                                "Butterflies & Moths", "Frogs and Toads", "Salamanders",
                                                "Lizards and Geckos", "Small Mammals", "Birds:Raptors",
                                                "Birds:Passerines", "Birds:Woodpeckers", 
                                                "Birds:Rails and Geese"), each = 6), times = 26))%>% 
  left_join(., ndvi, by = c("desert", "obsYear", "treatmentGroup")) %>% #add ndvi
  left_join(., areas, by = c("desert", "treatmentGroup")) %>% #add area
  left_join(., data2a, by = c("desert", "obsYear", "treatmentGroup", "funcGroup")) %>% #add data 
  mutate(ez_taxa = ifelse(startsWith(funcGroup, "Birds"), "Aves", "Other")) %>% #category Aves and Other
  mutate(totalObs = ifelse(is.na(totalObs), 0, totalObs)) %>%  # Total Obs NA -> 0 
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2, #standardize observations
         desert = as.factor(desert),
         treatmentGroup = factor(ifelse(startsWith(treatmentGroup, "never"), "Control", "Burned"), 
                                 levels = c( "Control", "Burned")),
         funcGroup = as.factor(funcGroup),
         ez_taxa = as.factor(ez_taxa),
         stzdTotalObs_rounded = ceiling(stzd_totalObs))

data_2000 <- filter(data, obsYear > 1999) # filter out anything before 2000 since no NDVI info

```
```{r prepare recovery data, include = FALSE}
data_r <- animals %>% 
  filter(treatmentGroup == "burned") %>% 
  merge(.,sites[,c("fireID", "fireMonth")], by = "fireID") %>% #NEED to add fire months
  mutate(yearsSinceFire = obsYear - fireYear, 
         pre_or_post = case_when(yearsSinceFire > 0 ~ "post",
                                 yearsSinceFire < 0 ~ "pre",
                                 yearsSinceFire == 0 ~ "SY"),
         n_years = abs(yearsSinceFire))

#find pre- post- for observations in the same year and replace SY in datafire with pre or post
SY <- filter(data_r, yearsSinceFire == 0) %>% 
  mutate(postingmonth = obsMonth - fireMonth,
    pre_or_post = case_when(postingmonth >0 ~ "post",
                            postingmonth < 0 ~ "pre",
                            yearsSinceFire == 0 ~ "SM"))
data_r$pre_or_post <- ifelse(data_r$pre_or_post == "SY", SY$pre_or_post, data_r$pre_or_post)
unique(data_r$pre_or_post) #check if any SM (same month); would need to further categorize

data_r <- left_join(data_r, ndvi, by = c("desert", "obsYear", "treatmentGroup"))
```
```{r data for pre-/post- all, include=FALSE}
###data for pre-/post- burned sites ALL
data_pp_b1 <-  data_r %>% 
  filter(n_years <=5) %>% 
  dplyr::select(c("ez_taxa", "funcGroup", "individualCount", 
                  "obsYear", "desert", "fireID", 
                  "fireName", "fireYear", "fireMonth", 
                  "yearsSinceFire", "pre_or_post", "n_years", "ndvi")) %>% 
  group_by(desert, obsYear, fireID, 
           fireYear, yearsSinceFire, 
           ez_taxa, funcGroup, 
           pre_or_post, n_years, ndvi) %>% 
  summarize(totalObs = n()) %>% 
  left_join(., filter(areas, treatmentGroup == "burned"), by = "desert") %>% #add area
  mutate(stzdObs = ceiling((totalObs/area_km2)*10000)) %>% 
  ungroup() %>% group_by(desert) 

unique(data_pp_b1$funcGroup)

### add zeros for years with no occurrences reported
fireYear <- data_pp_b1 %>% 
  filter(n_years <=5) %>% 
  group_by(fireYear, desert, fireID) %>% 
  summarize(total = n()) %>% 
  dplyr::select(-total) %>% 
  filter(fireYear <= 2015)

#repeats each 8 functional groups * 11 years for -5 to +5
data_pp_b2 <- data.frame(rep(fireYear$fireYear, each = (length(unique(data_pp_b1$funcGroup)) * 11)), 
                         rep(fireYear$desert, each = (length(unique(data_pp_b1$funcGroup)) * 11)), 
                         rep(fireYear$fireID, each = (length(unique(data_pp_b1$funcGroup)) * 11)), 
                         rep ((unique(data_pp_b1$funcGroup)), 
                              each = 11, times = nrow(fireYear)))

names(data_pp_b2)[1] <- "fireYear"
names(data_pp_b2)[2] <- "desert"
names(data_pp_b2)[3] <- "fireID"
names(data_pp_b2)[4] <- "funcGroup"

#second column = list of +/- since fire / from -5 to +5
data_pp_b2$yearsSinceFire<- rep(-5:5, nrow(fireYear))

#make a column with obsYear
data_pp_b2 <- data_pp_b2 %>% mutate(obsYear = fireYear + yearsSinceFire)

#merge the occurrences for burn sites with the data frame created and replace with zeros when no occurrences were reported
data_pp_b2<- left_join(data_pp_b2, data_pp_b1, 
                       by = c("desert", "obsYear", "fireYear", "fireID", "yearsSinceFire", "funcGroup")) %>% 
  filter(yearsSinceFire != 0 | yearsSinceFire == 0 & !is.na(pre_or_post)) %>% 
  mutate(treatmentGroup = ifelse(is.na(treatmentGroup), "burned", treatmentGroup),
         pre_or_post = ifelse(is.na(pre_or_post), case_when(yearsSinceFire > 0 ~ "post",
                                                            yearsSinceFire < 0 ~ "pre",
                                                            yearsSinceFire == 0 ~ "same year"), pre_or_post))

###data for pre-/post- control sites###

#first column = list of fireYear
###old code
# fireYear <- data_pp_b %>% filter(n_years <=5) %>% {unique(.$fireYear)} %>% sort() %>% rep(.,each=11)


data_c <- data.frame(rep(fireYear$fireYear, each = (length(unique(data_pp_b1$funcGroup)) * 11)), 
                     rep(fireYear$desert, each = (length(unique(data_pp_b1$funcGroup)) * 11)), 
                     rep((unique(data_pp_b1$funcGroup)), each = 11, times = nrow(fireYear)))

names(data_c)[1] <- "fireYear"
names(data_c)[2] <- "desert"
names(data_c)[3] <- "funcGroup"

#second column = list of +/- since fire / from -5 to +5
data_c$yearsSinceFire<- rep(-5:5, nrow(fireYear))

#make a column with obsYear
data_c <- data_c %>% mutate(obsYear = fireYear + yearsSinceFire)


totalObs <- animals %>% 
  filter(treatmentGroup == "never burned") %>% 
  group_by(obsYear, desert, ez_taxa, funcGroup) %>% 
  summarize(totalObs = n())

data_c <- merge(data_c, totalObs) %>% mutate(pre_or_post = case_when(yearsSinceFire > 0 ~ "post",
                                                                     yearsSinceFire < 0 ~ "pre",
                                                                     yearsSinceFire == 0 ~ "same year")) %>% 
  left_join(., filter(ndvi, treatmentGroup == "never burned"), by = c("desert", "obsYear")) %>%#add ndvi
  dplyr::select(-treatmentGroup) %>% 
  left_join(., filter(areas, treatmentGroup == "never burned"), by = "desert") %>% #add area
  mutate(stzdObs = ceiling((totalObs/area_km2)*10000), treatmentGroup = "control",
         n_years = abs(yearsSinceFire),
         fireID = NA) %>% 
  filter(yearsSinceFire != 0)

data_pp <- rbind(data_pp_b2, data_c) %>% 
  mutate(pre_or_post = factor(pre_or_post, levels = c( "pre", "post")), 
         treatmentGroup = factor(treatmentGroup, levels = c("control", "burned")),
         desert = as.factor(desert),
         totalObs = ifelse(is.na(totalObs), 0, totalObs),
         stzdObs = ifelse(is.na(stzdObs), 0, stzdObs)) # Total Obs NA -> 0 )
```

## Occurrences before and after fire
### graphs
Overall occurrences of raptors and passerines between 1995-2020

```{r prepost passerines & raptors, echo = FALSE}
#occurrences for raptors and passerines
ggplot(filter(data_pp, funcGroup == "Birds:Passerines" | funcGroup == "Birds:Raptors"), aes(x = treatmentGroup, y =  stzdObs, fill = factor(pre_or_post, levels = c("pre", "post")))) +
  geom_boxplot()+
  scale_fill_aaas(labels = c("Before fire", "After fire")) +
  #scale_x_discrete(labels = c("Burned", "Control")) +
  theme(legend.title = element_blank()) +
  xlab("Treatment Group") +
  ylab(bquote("Bird occurrences reported per 10,000 km"^2)) +
  facet_grid(vars(funcGroup),vars(desert))
```

The average number of occurrences reported 5 years before fire and 5 years after fire. Zeros were added to years when no occurrences were reported.

```{r pre-post- pass/rapt 5yr average, echo = FALSE}
#mean occurrences 5yrs before and after fire

data_pp_5yr_1 <- filter(data_pp, funcGroup == "Birds:Passerines" | funcGroup == "Birds:Raptors") %>% 
  group_by(desert, fireYear, pre_or_post, funcGroup, treatmentGroup, fireID) %>% 
  summarize(mean_occurrence = ceiling(mean(stzdObs)))


ggplot(data_pp_5yr_1, aes(x = treatmentGroup, y =  mean_occurrence, fill = factor(pre_or_post, levels = c("pre", "post")))) +
  geom_boxplot()+
  scale_fill_aaas(labels = c("Before fire", "After fire")) +
  #scale_x_discrete(labels = c("Burned", "Control")) +
  theme(legend.title = element_blank()) +
  xlab("Treatment Group") +
  ylab(bquote("5-yr average of passerines and raptors \noccurrences reported per 10,000 km"^2)) +
  facet_grid(vars(funcGroup),vars(desert))

```
```{r pre-post- all aves 5yr avg, echo = FALSE}
#mean occurrences 5yrs before and after fire

data_pp_5yr_2 <- filter(data_pp, grepl("Birds", funcGroup)) %>% 
  group_by(desert, fireYear, pre_or_post, funcGroup, treatmentGroup, fireID) %>% 
  summarize(mean_occurrence = ceiling(mean(stzdObs)))


ggplot(data_pp_5yr_2, aes(x = treatmentGroup, y =  mean_occurrence, fill = factor(pre_or_post, levels = c("pre", "post")))) +
  geom_boxplot()+
  scale_fill_aaas(labels = c("Before fire", "After fire")) +
  #scale_x_discrete(labels = c("Burned", "Control")) +
  theme(legend.title = element_blank()) +
  xlab("Treatment Group") +
  ylab(bquote("5-yr average of all bird occurrences reported per 10,000 km"^2)) +
  facet_grid(vars(funcGroup),vars(desert))

```
```{r pre-post- other 5yr avg, echo = FALSE}
#mean occurrences 5yrs before and after fire

data_pp_5yr_3 <- filter(data_pp, !grepl("Birds", funcGroup)) %>% 
  group_by(desert, fireYear, pre_or_post, funcGroup, treatmentGroup, fireID) %>% 
  summarize(mean_occurrence = ceiling(mean(stzdObs)))


ggplot(data_pp_5yr_3, aes(x = treatmentGroup, y =  mean_occurrence, fill = factor(pre_or_post, levels = c("pre", "post")))) +
  geom_boxplot()+
  scale_fill_aaas(labels = c("Before fire", "After fire")) +
  #scale_x_discrete(labels = c("Burned", "Control")) +
  theme(legend.title = element_blank()) +
  xlab("Treatment Group") +
  ylab(bquote("5-yr average of non-avian ES occurrences reported per 10,000 km"^2)) +
  facet_grid(vars(desert))
```
```{r pre-post- all 5yr avg, echo = FALSE}
#mean occurrences 5yrs before and after fire

data_pp_5yr_4 <- data_pp %>% 
  group_by(desert, fireYear, pre_or_post, funcGroup, treatmentGroup, fireID) %>% 
  summarize(mean_occurrence = ceiling(mean(stzdObs))) %>% 
  mutate(ez_taxa = ifelse(grepl("Birds", funcGroup), "Aves", "Other"))

ggplot(data_pp_5yr_4, aes(x = treatmentGroup, y =  mean_occurrence, fill = factor(pre_or_post, levels = c("pre", "post")))) +
  geom_boxplot()+
  scale_fill_aaas(labels = c("Before fire", "After fire")) +
  #scale_x_discrete(labels = c("Burned", "Control")) +
  theme(legend.title = element_blank()) +
  xlab("Treatment Group") +
  ylab(bquote("5-yr average of all occurrences reported per 10,000 km"^2)) +
  facet_grid(vars(desert))
```

### GLMM model w/ emmeans - pre/post

#### passerine and raptor only
```{r stats on pass/rapt recovery}
pp_nb1 <- glmmTMB(mean_occurrence ~ pre_or_post + treatmentGroup + funcGroup + (1|desert), family = nbinom1, data = data_pp_5yr_1)

#validate model using simulated residuals 
simulationOutput <- simulateResiduals(fittedModel = pp_nb1, plot = F)
#plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)

summary(pp_nb1)

#stepwise regression to select best predictors; both summary above and stepAIC show that funcGroup not significant
null <- glmmTMB(mean_occurrence ~ 1, family = nbinom1, data = data_pp_5yr_1)
stepAIC(pp_nb1, scope=list(lower=null, upper=pp_nb1), data=data_pp_5yr, direction='backward')

pp_nb1 <- glmmTMB(mean_occurrence ~ pre_or_post + treatmentGroup + (1|desert), family = nbinom1, data = data_pp_5yr_1)

pp_nb1 <- glmmTMB(mean_occurrence ~ pre_or_post*treatmentGroup + (1|desert), family = nbinom1, data = data_pp_5yr_1)

emm_pp <- emmeans(pp_nb1, pairwise ~ pre_or_post + treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb1, pairwise ~ treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb1, pairwise ~ pre_or_post|treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb1, pairwise ~ treatmentGroup|pre_or_post)
summary(emm_pp)

```

#### all aves
```{r stats on all aves recovery}
pp_nb2 <- glmmTMB(mean_occurrence ~ pre_or_post*treatmentGroup + funcGroup + (1|desert), family = nbinom1, data = data_pp_5yr_2)

#validate model using simulated residuals 
simulationOutput <- simulateResiduals(fittedModel = pp_nb2, plot = F)
#plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)

summary(pp_nb2)

#stepwise regression to select best predictors; both summary above and stepAIC show that funcGroup not significant
null <- glmmTMB(mean_occurrence ~ 1, family = nbinom1, data = data_pp_5yr_2)
stepAIC(pp_nb2, scope=list(lower=null, upper=pp_nb2), data=data_pp_5yr_2, direction='backward')

emm_pp <- emmeans(pp_nb2, pairwise ~ pre_or_post + treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb2, pairwise ~ treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb2, pairwise ~ pre_or_post|treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb2, pairwise ~ treatmentGroup|pre_or_post)
summary(emm_pp)
```

#### non-avian species
```{r stats on other recovery}
pp_nb3 <- glmmTMB(mean_occurrence ~ pre_or_post*treatmentGroup + funcGroup + (1|desert), family = nbinom2, data = data_pp_5yr_3)

#validate model using simulated residuals 
simulationOutput <- simulateResiduals(fittedModel = pp_nb3, plot = F)
#plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
                  
summary(pp_nb3)


#stepwise regression to select best predictors; both summary above and stepAIC show that funcGroup not significant
null <- glmmTMB(mean_occurrence ~ 1, family = nbinom1, data = data_pp_5yr_3)
stepAIC(pp_nb3, scope=list(lower=null, upper=pp_nb3), data=data_pp_5yr_aves, direction='backward')

emm_pp <- emmeans(pp_nb3, pairwise ~ pre_or_post + treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb3, pairwise ~ treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb3, pairwise ~ pre_or_post|treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb3, pairwise ~ treatmentGroup|pre_or_post)
summary(emm_pp)
```

#### all species
```{r stats on all recovery}
pp_nb4 <- glmmTMB(mean_occurrence ~ pre_or_post*treatmentGroup + ez_taxa + (1|desert), family = nbinom2, data = data_pp_5yr_4)

#validate model using simulated residuals 
simulationOutput <- simulateResiduals(fittedModel = pp_nb4, plot = F)
plot(simulationOutput)
testOverdispersion(simulationOutput)
testZeroInflation(simulationOutput)

summary(pp_nb4)


#stepwise regression to select best predictors; both summary above and stepAIC show that funcGroup not significant
null <- glmmTMB(mean_occurrence ~ 1, family = nbinom1, data = data_pp_5yr_4)
stepAIC(pp_nb4, scope=list(lower=null, upper=pp_nb4), data=data_pp_5yr_4, direction='backward')

emm_pp <- emmeans(pp_nb4, pairwise ~ pre_or_post + treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb4, pairwise ~ treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb4, pairwise ~ pre_or_post|treatmentGroup)
summary(emm_pp)

emm_pp <- emmeans(pp_nb4, pairwise ~ treatmentGroup|pre_or_post)
summary(emm_pp)
```

## Recovery over-time
```{r data for over-time, include=FALSE}

###data for over-time for burned sites
burned <- animals %>% 
  filter(treatmentGroup == "burned") %>% 
  merge(.,sites[,c("fireID", "fireMonth")], by = "fireID") %>% #NEED to add fire months
  mutate(yearsSinceFire = obsYear - fireYear, 
         pre_or_post = case_when(yearsSinceFire > 0 ~ "post",
                                 yearsSinceFire < 0 ~ "pre",
                                 yearsSinceFire == 0 ~ "SY"),
         n_years = abs(yearsSinceFire))

#find pre- post- for observations in the same year and replace SY in datafire with pre or post
SY <- filter(burned, yearsSinceFire == 0) %>% 
  mutate(postingmonth = obsMonth - fireMonth,
         pre_or_post = case_when(postingmonth >0 ~ "post",
                                 postingmonth < 0 ~ "pre",
                                 yearsSinceFire == 0 ~ "SM"))

burned$pre_or_post <- ifelse(burned$pre_or_post == "SY", SY$pre_or_post, burned$pre_or_post)
unique(burned$pre_or_post) #check if any SM (same month); would need to further categorize

burned <- burned %>% 
  filter(pre_or_post == "post") %>% 
  dplyr::select(c("desert", "obsYear", "fireYear", "species",
                  "yearsSinceFire")) %>% 
  mutate(count = 1) %>% 
  mutate(yearsSinceFire = ifelse(yearsSinceFire == 0, 1, yearsSinceFire))

### get fire years to make control
fireYear <- burned %>% 
  group_by(fireYear, desert) %>% 
  summarize(total = n()) %>% 
  dplyr::select(-total) 

### make control
control <- burned %>% group_by(desert, fireYear) %>% 
  summarize(maxTime = max(yearsSinceFire)) %>% 
  filter(maxTime != 0)

### get species info for control
control_species <- animals %>% 
  filter(treatmentGroup == "never burned", obsYear > 1999) %>% 
  group_by(desert, obsYear, species) %>%
  summarize(count = n()) 

### how many species each year in control?

control_sp_total <- control_species %>% 
  group_by(desert, obsYear) %>%
  summarize(count = n())


  
## vectors for control df
yearsSinceFire <- c()
desert <- c()
fireYear <- c()


for (i in 1:nrow(control)) {
  yearsSinceFire <-  c(yearsSinceFire, rep(1:control$maxTime[i], 1))
}

for (i in 1:nrow(control)) {
  desert <-  c(desert, rep(control$desert[i], each = control$maxTime[i]))
}

for (i in 1:nrow(control)) {
  fireYear <-  c(fireYear, rep(control$fireYear[i], each = control$maxTime[i]))
}


control <- data.frame(desert, fireYear, yearsSinceFire) %>% 
  mutate(obsYear = fireYear + yearsSinceFire) %>% 
  filter(obsYear < 2021) %>% 
  left_join(., dplyr::select(control_species, -count), by = c("obsYear", "desert"))

## make df with just desert, TSF, and species for both burned and control sites

burned <- burned %>% group_by(desert, yearsSinceFire, species) %>% 
  summarize(count = n()) %>% 
  dplyr::select(-count)

control <- control %>% group_by(desert, yearsSinceFire, species) %>% 
  summarize(count = n()) %>% 
  dplyr::select(-count)

unique_b <- anti_join(burned, control) %>% 
  group_by(desert, yearsSinceFire) %>% 
  summarize(unique_b = n())

unique_c <- anti_join(control, burned) %>% 
  group_by(desert, yearsSinceFire) %>% 
  summarize(unique_c = n())

shared <- anti_join(burned, anti_join(burned, control)) %>% 
  group_by(desert, yearsSinceFire) %>% 
  summarize(shared = n())

tsf_df <- full_join(shared, unique_b, by = c("desert", "yearsSinceFire")) %>% 
  full_join(., unique_c, by = c("desert", "yearsSinceFire")) %>% 
  mutate(unique_b = ifelse(is.na(unique_b), 0, unique_b),
         shared = ifelse(is.na(shared), 0, shared),
         unique_c = ifelse(is.na(unique_c), 0, unique_c),
         si = (2*shared)/(unique_b + unique_c))

```
```{r graph for over-time recovery}
ggplot(data = tsf_df, aes(x = yearsSinceFire, y = si, color = desert)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  ylab("Sorensen's Similarity Index")
```
 
 