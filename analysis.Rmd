---
title: "Controls"
author: "Marina"
date: "11/16/2021"
output: html_document
---

```{r packages and data, message=FALSE}
library(tidyverse)
library(mgcv)
library(sf)
library(lwgeom)
library(lme4)
library(ggsci)
library(ggrepel)
library(stats)


setwd("~/GitHub/desert-fires-impact-biodiversity")

animals <- st_read("shapefiles/animals/animals_51022.shp") %>% 
  st_drop_geometry() %>% 
  rename(obsID = TARGET_FID, order = order_, individualCount = individual, obsDay = day, obsMonth = month, obsYear = year, institutionalCode = institutio, treatmentGroup = treatmentG, fireName = INCIDENT, fireYear = FIRE_YEARn, fireSize = GISAcres) %>% 
  select(-c("verbatimSc", "issue", "coordinate", 'nearRd_FID', "nearUA_FID")) %>% 
  filter(obsYear > 1999, obsYear < 2021, species != "Canis lupus", species != "Balaenoptera musculus", species != "Grus canadensis")
  

ndvi_burned <- read_csv("data/mean_ndvi_burned.csv") %>% 
  mutate(treatmentGroup = "burned")
ndvi_nb <- read_csv("data/mean_ndvi_never_burned.csv") %>% 
  mutate(treatmentGroup = "never burned")

ndvi <- rbind(ndvi_burned, ndvi_nb) %>% 
  rename(obsYear = year)

data <- animals %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n()) %>% 
  filter(treatmentGroup != "burned prior 2000")

```

## Just some basic info for methodology
who did the science?
Taxa of species occurrences
fire sites

```{r tables and graphs for methods part 1of3  - cit sci, message=FALSE}

## how much fo the data is citizen science? and which publisher contributed the most data?
inst <- unique(animals$institutionalCode)
inst <- inst[-5] #remove NA

filter(animals, !institutionalCode %in% inst)

animals <- animals %>% 
  mutate(institutionalCode = ifelse(is.na(institutionalCode) & collection == "Observations", "Observation.org", institutionalCode)) %>% 
  mutate(institutionalCode = ifelse(is.na(institutionalCode) & collection == "Bird sounds", "Xeno-canto", institutionalCode)) %>% 
  mutate(institutionalCode = ifelse(institutionalCode == "CLO" & collection == "GBBC", "Great Backyard Bird Count", institutionalCode)) %>% 
  mutate(institutionalCode = ifelse(institutionalCode == "CLO" & collection == "ML", "CLO Macaulay Library", institutionalCode)) %>% 
  mutate(institutionalCode = ifelse(is.na(institutionalCode) & order == "Lepidoptera", "eButterfly", institutionalCode)) %>% 
  mutate(institutionalCode = ifelse(is.na(institutionalCode), "BOLD", institutionalCode))
	

animals$institutionalCode[animals$institutionalCode == "CLO"] <- "eBird"

cit_sci <- animals %>% group_by(institutionalCode) %>%
  filter(treatmentGroup != "burned prior 2000") %>% 
  summarize(total_rec = n()) %>% 
  mutate(percent = total_rec/sum(total_rec) * 100)

view(cit_sci)

animals %>% filter(is.na(institutionalCode))

sum(cit_sci$total_rec)

```

```{r tables and graphs for methods part 2of3 - class composition of data, message=FALSE}

## which class of species makes up the occurrences
species_dist <- animals %>% group_by(class) %>% 
  filter(treatmentGroup != "burned prior 2000") %>% 
  summarize(total_rec = n()) %>% 
  arrange(desc(-total_rec)) %>% 
  mutate(percent = (total_rec/sum(total_rec)),label = (paste0(class, "\n", total_rec)))
  

view(species_dist)

# make charts of species distribution

sum(species_dist$total_rec) - species_dist$total_rec[species_dist$class == "Aves"]

category <- c("Aves", "Other")
occurrences <- c(species_dist$total_rec[species_dist$class == "Aves"], sum(species_dist$total_rec) - species_dist$total_rec[species_dist$class == "Aves"])


sp_chart <- data.frame(category, occurrences) %>% 
  mutate(percent = occurrences/sum(occurrences),
         ymax = cumsum(percent),
         ymin = c(0, head(ymax, n = -1)),
         labelPosition = (ymax + ymin) / 2,
         label = paste0(category, "\n", occurrences))

#donut chart

ggplot(sp_chart, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=category)) +
  geom_rect() +
  geom_text(x=3.5, aes(y=labelPosition, label=label), size=4, color = "white", fontface = "bold") +
  coord_polar(theta="y", start = pi/2) + # Try to remove that to understand how the chart is built initially
  xlim(c(2, 4)) + # Try to remove that to see how to make a pie chart
  theme_void() +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("grey",  "#7a83a2")) +
  labs(fill = "Taxa")
     

# donut chart for other category

#color <- c("#deeeeb", "#468a7a", "#2b544b", "#7aa299", "#69b3a2", "#c4e1db") 
color <- c("#46558a", "#697ab3", "#dee2ee", "#8b98c4", "#b7bfdb", "#7a83a2")


species_dist %>% 
  filter(class != "Aves") %>% 
  arrange(desc(-total_rec)) %>% 
  mutate(taxa = "taxon", 
         percent = (total_rec/sum(species_dist$total_rec)), 
         ymax = cumsum(percent),
         ymin = c(0, head(ymax, n = -1)),
         labelPosition = (ymax + ymin) / 2) %>% 
  ggplot(aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=class)) +
  geom_rect() +
  #geom_label(x=c(4.5,4.5,4.5, 3.5,3.5, 3.5), aes(y=labelPosition, label=label), size=4) +
  geom_label_repel(aes(x = 4, y = labelPosition, label = label),
                   size = 4.5, nudge_x = 1, show.legend = FALSE) +
  coord_polar(theta="y") +
  xlim(c(2, 4.5)) +
  theme_void() +
  theme(legend.position = "none") +
  scale_fill_manual(values = color) +
  labs(fill = "Taxa")
  


# all as a bar chart
species_dist %>%
  arrange(desc(-total_rec)) %>%
  mutate(class=factor(class, class)) %>%
  ggplot( aes(x=class, y=total_rec) ) +
    geom_segment(aes(x=class ,xend=class, y=0, yend=total_rec), color="grey", size = 2) +
    geom_point(size=5, color=c("#242c47", "#242c47", "#242c47", "#242c47", "#242c47", "#242c47", "#697ab3")) +
    coord_flip() +
    geom_text(aes(label = total_rec), nudge_x = 0.35) +
    theme_classic() +
    theme(panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          legend.position="none",
          axis.text = element_text(size = 12)) +
    xlab("") +
    ylab("Occurrences") 

```

iNaturalist - CS
eBird - CS
Naturgucker - CS - German
PRBO - non-CS Point Reyes Bird Observatory (formerly) now known as Point Blue Conservation Science--bird survey datasets are collected following a standard survey protocol to be used for monitoring, research or decision-making purposes published by Avian Knowledge Network
LEPSOC - CS

collection 
Bird sounds - CS Xeno-canto
observation - Observation.org CS - Netherlands


```{r tables and graphs for methods part 3of3 - make sites appendix table, message=FALSE}

sites <- read_csv("data/sitesv2-2022.csv") %>% 
  select(-desert)

sites_sf <- st_read("shapefiles/fires/fires2000.shp")

fireid <- unique(sites$fireID)

sites_sf <- sites_sf %>% filter(fireID %in% fireid)

sites_sf$confirmarea <- st_geod_area(sites_sf)

view(sites_sf) #areas for area_km2 confirmed

#just the fires for occurrences
fireid <- unique(animals$fireID)[-1]

sites$fireID <- as.factor(sites$fireID)
sites_sf$fireID <- as.factor(sites_sf$fireID)


sites_sf <- as.data.frame(sites_sf) %>% filter(fireID %in% fireid) %>%
  left_join(sites, by = "fireID") %>% 
  select(c(desert, INCIDENT, FIRE_YEARn, fireID, area_km2, startDate))

#write.csv(sites_sf, "thesis/sites.csv")

```


```{r tables and graphs for methods part 4of4 - total occurrences per treatment burn treatments}

animals %>% group_by(desert, treatmentGroup) %>% 
  summarize(total_occ = n()) %>% 
  filter(treatmentGroup != "burned prior 2000")


```



## Get areas to standardize observations

```{r areas, include=FALSE}
fireid <- unique(animals$fireID)

fire_area <- st_read("shapefiles/fires/fires2000.shp") %>% #polygons for never-burned desert sites
        st_transform(crs = 4326) %>% #transform data to wgs84 to match raster
        filter(fireID %in% fireid)

fire_area_sj <- fire_area %>% 
  filter(desert == "San Joaquin")
fire_area_moj <- fire_area %>% 
  filter(desert == "Mojave")
fire_area_son <- fire_area %>% 
  filter(desert == "Sonoran")


desert <- c("San Joaquin", "Mojave", "Sonoran")
area_km2 <- c(as.numeric(sum(fire_area_sj$area_km2)),
              as.numeric(sum(fire_area_moj$area_km2)),
              as.numeric(sum(fire_area_son$area_km2)))

areas <- data.frame(desert, area_km2) %>% 
  mutate(treatmentGroup = "burned")

head(areas)

nb_area <- st_read("shapefiles/deserts/minus-fires/deserts-minus-fires.shp") %>% #polygons for never-burned desert sites
        st_transform(crs = 4326) #transform data to wgs84 to match raster

nb_area_sj <- nb_area %>% 
  filter(desert == "San Joaquin")
nb_area_moj <- nb_area %>% 
  filter(desert == "Mojave")
nb_area_son <- nb_area %>% 
  filter(desert == "Sonoran")

nb_area_moj$area_km2 <- st_geod_area(nb_area_moj) / 1000000
as.numeric(sum(nb_area_moj$area_km2))
nb_area_sj$area_km2 <- st_geod_area(nb_area_sj) / 1000000
as.numeric(sum(nb_area_sj$area_km2))
nb_area_son$area_km2 <- st_geod_area(nb_area_son) / 1000000
as.numeric(sum(nb_area_son$area_km2))

area_km2 <- c(as.numeric(sum(nb_area_sj$area_km2)),
              as.numeric(sum(nb_area_moj$area_km2)),
              as.numeric(sum(nb_area_son$area_km2)))
areas_nb <- data.frame(desert, area_km2) %>% 
  mutate(treatmentGroup = "never burned")
areas <- rbind(areas, areas_nb)

head(areas)

#write.csv(data, "data/animal_observations_2022.csv")

```


## NDVI
Summarize how many animal observations in each treatment group and add ndvi
Plot the average ndvi for the the three deserts

```{r NDVI}
data <- animals %>%
  group_by(obsYear, treatmentGroup, desert) %>% 
  summarize(totalObs = n()) %>% 
  filter(treatmentGroup != "burned prior 2000")

data <- left_join(data, ndvi, by = c("desert", "obsYear", "treatmentGroup"))

data <- left_join(data, areas, by = c("desert", "treatmentGroup")) %>% 
  mutate(stzd_totalObs = (totalObs * 1000)/area_km2) #total observation per 1000 km2

data$desert <- as.factor(data$desert)
data$treatmentGroup <- as.factor(data$treatmentGroup)

head(data)

avg_ndvi <- data %>% group_by(treatmentGroup, desert) %>% summarize(avg_ndvi = mean(ndvi), totalObs = sum(stzd_totalObs))

head(avg_ndvi)

ggplot(data, aes(x = obsYear, y = ndvi, color = treatmentGroup, shape = desert)) +
  geom_point() +
  ylim(0, 1) +
  xlim(2000, 2020) +
  facet_grid(vars(treatmentGroup)) +
  ylab("ndvi") +
  scale_color_manual(values = c("firebrick4", "skyblue4"))

ggplot(avg_ndvi, aes(x = desert, y = avg_ndvi, shape = treatmentGroup)) +
  geom_point() +
  ggtitle("Average NDVI between 2000 and 2020") +
  ylab("Average NVDI") +
  xlab("Desert")
  
ggplot(data, aes(x = treatmentGroup, y = ndvi, color = desert)) +
  geom_boxplot(outlier.shape = 18)  +
  ylab("Yearly average NDVI") +
  xlab("") +
  scale_color_uchicago("dark") +
  theme_classic() + 
  theme(axis.text.y = element_text(size = 12), 
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12)) +
  scale_x_discrete(labels=c("Burned area", "Control"))


```


## how many occurrneces over the years?

```{r viz on occurrences over the years}
head(data)

# how have the number of occurrences changed throughout the years?
ggplot(data, aes(x = obsYear, y = stzd_totalObs, color = treatmentGroup)) +
  geom_point(size = 2) +
  geom_smooth(method = "gam", aes(fill = treatmentGroup)) +
  ylim(0, 70) +
  xlim(2000, 2020) +
  facet_grid(vars(desert)) +
  ylab(bquote('Total occurrences reported per 1000 km'^2)) +
  xlab("Year") +
  scale_color_manual(values = c("#b3697a", "#697ab3"),
                     name = "Burn Treatment",
                     labels = c("Burned", "Control")) +
  scale_fill_manual(values = c("#b3697a", "#697ab3"),
                    name = "Burn Treatment",
                    labels = c("Burned", "Control")) +
  theme_bw()

summary(data)

```




## number fires per year

```{r}

# number of unique species per treatment group
species <-  animals %>% 
  filter(treatmentGroup != "burned prior 2000") %>% 
  group_by(desert, treatmentGroup) %>% 
  summarize(richness = n_distinct(species))

#number of fires per year per desert

sites_sf %>% group_by(desert, FIRE_YEARn) %>% 
  summarize(total_fires = n(), total_area_burned = sum(area_km2)) %>% 
  ggplot(aes(x = FIRE_YEARn, y = total_fires, color = desert)) +
  geom_segment(aes(x = FIRE_YEARn, xend = FIRE_YEARn, y = 0, yend = total_fires), color = "black") +
  geom_point(aes(size = total_area_burned)) +
  theme_classic() +
  facet_grid(rows = vars(desert)) +
  scale_size_continuous(breaks = c(5, 25, 250), name = bquote("Total burned area "(km^2))) +
  scale_x_continuous(breaks = c(2000:2020)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  xlab("Year") +
  ylab("Total number of fires") +
  scale_color_uchicago("dark", guide = 'none')
  


```




## stats Model 

### Time series _ PAUSED

```{r}
#convert occurrences to time series matrix month x years

timeseries <- animals %>% filter(treatmentGroup != "burned prior 2000") %>% 
  group_by(obsYear, treatmentGroup) %>% 
  summarize(total_occurrences = n()) %>% 
  ungroup()

timeseries_b <- timeseries %>% filter(treatmentGroup == "burned") %>% 
  select(-c(obsYear, treatmentGroup)) %>% as.ts(start = 2000, end = 2020, frequency = 1)

timeseries_con <- timeseries %>% filter(treatmentGroup == "never burned") %>% 
  select(-c(obsYear, treatmentGroup)) %>% as.ts(start = 2000, end = 2020, frequency = 1)


timeseries <- timeseries %>% 
  select(-obsYear) %>% as.ts(start = 2000, end = 2020, frequency = 1)


ts.plot(timeseries_b) + abline(reg=lm(timeseries_b~time(timeseries_b)))
ts.plot(timeseries_con) + abline(reg=lm(timeseries_con~time(timeseries_con)))

ts.plot(timeseries) + abline(reg=lm(timeseries~time(timeseries)))

lm(timeseries_b~time(timeseries_b))
lm(timeseries_con~time(timeseries_con))


acf(timeseries_b)
acf(timeseries_con)
```


### linear model
 
```{r}
model_lm1 <- lm(stzd_totalObs ~ obsYear + ndvi + desert + treatmentGroup, data = data)
summary(model_lm1)

model_lm2 <- lm(stzd_totalObs ~ obsYear + ndvi + treatmentGroup, data = data)
summary(model_lm2)

model_lm3 <- lm(stzd_totalObs ~ obsYear + desert + ndvi, data = data)
summary(model_lm3)


model_gam1 <- gam(stzd_totalObs ~ s(obsYear, by = desert) + s(ndvi, by = desert) + desert + treatmentGroup, data = data)
summary(model_gam1)

model_gam2 <- gam(stzd_totalObs ~ s(obsYear, by = treatmentGroup) + s(ndvi, by = treatmentGroup) + desert + treatmentGroup, data = data)
summary(model_gam2)

gam.check(model_gam1)
gam.check(model_gam2)
```

### ANOVA test

```{r}
head(data)

ndvi_anova  <- aov(ndvi ~ desert + treatmentGroup, data = data)
summary(ndvi_anova)

ndvi_interaction_anova  <- aov(ndvi ~ desert*treatmentGroup, data = data)
summary(ndvi_interaction_anova)

AIC(ndvi_interaction_anova)

plot(ndvi_interaction_anova)

occ_anova <- aov(stzd_totalObs ~ desert + treatmentGroup + ndvi, data = data)
summary(occ_anova)

occ_anova_int <- aov(stzd_totalObs ~ obsYear + desert*ndvi + treatmentGroup, data = data)
summary(occ_anova_int)

plot(occ_anova_int)

```

IV tested = deserts and treatment group
sum sq = total variation between the group means and the overall means
The larger the f value the more likely the variation is real and not due to change
p value = significance


